<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotating Shift Swap Tool</title>
  <style>
    :root{
      --bg:#fff; --ink:#111; --muted:#666; --grid:#111; --hdr:#0b0b0b;
      --a:#cfcfcf; --b:#f8f8f8; --c:#dedede;
      --rdo:#0b0b0b; --rdoInk:#fff;
      --mdo:#bfbfbf; --mdoInk:#111;
      --pick:#ffe08a; --swap:#98d7ff;
      --warn:#b30000; --ok:#0a7a00;
      --shadow:0 2px 10px rgba(0,0,0,.08);
      --radius:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans);}
    .topbar{position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:2px solid var(--grid);padding:10px 12px;}
    .row{display:flex;gap:10px;align-items:end;flex-wrap:wrap;}
    .spacer{flex:1}
    .ctl{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted);}
    .ctl select,.ctl input{
      font-size:14px;padding:8px 10px;border:2px solid var(--grid);border-radius:8px;background:#fff;color:var(--ink);
      min-width:160px;
    }
    button{font-size:14px;padding:10px 12px;border:2px solid var(--grid);background:#fff;border-radius:999px;cursor:pointer;}
    button.primary{background:var(--hdr);color:#fff;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .pill{font-size:12px;padding:6px 10px;border:2px solid var(--grid);border-radius:999px;background:#fff;white-space:nowrap;font-family:var(--mono);}
    .pill.ok{border-color:var(--ok);color:var(--ok);}
    .pill.bad{border-color:var(--warn);color:var(--warn);}

    .legend{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;font-size:12px;}
    .chip{border:2px solid var(--grid);border-radius:999px;padding:4px 10px;display:flex;align-items:center;gap:8px;background:#fff;font-family:var(--mono);}
    .sw{width:16px;height:12px;border:2px solid var(--grid);border-radius:4px;}
    .sw.a{background:var(--a);} .sw.b{background:var(--b);} .sw.c{background:var(--c);}
    .sw.rdo{background:var(--rdo);} .sw.mdo{background:var(--mdo);}
    .sw.pick{background:var(--pick);} .sw.swap{background:var(--swap);}

    .wrap{padding:12px;}
    .panel{border:2px solid var(--grid);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#fff;margin-bottom:12px;}
    .monthHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--hdr);color:#fff;font-weight:900;letter-spacing:.5px;text-transform:uppercase;font-size:14px;}
    .monthHeader small{opacity:.85;font-weight:700;text-transform:none;letter-spacing:0;font-size:12px;}
    .scrollX{overflow:auto;}

    table{border-collapse:collapse;width:max-content;min-width:100%;table-layout:fixed;font-family:var(--mono);font-size:12px;}
    th,td{border:1px solid var(--grid);padding:0;text-align:center;vertical-align:middle;}
    th.stickyLeft, td.stickyLeft{position:sticky;left:0;z-index:5;background:#fff;}
    th.stickyLeft2, td.stickyLeft2{position:sticky;left:240px;z-index:5;background:#fff;}
    .colName{width:240px;min-width:240px;max-width:240px;}
    .colSlot{width:80px;min-width:80px;max-width:80px;}
    .colDay{width:36px;min-width:36px;max-width:36px;}

    thead .dayTop{background:var(--hdr);color:#fff;font-weight:900;}
    thead .dow{background:#111;color:#fff;font-weight:800;font-size:11px;}
    thead .band{background:var(--hdr);color:#fff;text-transform:uppercase;letter-spacing:.5px;}
    thead .cov{background:#fff;color:#111;font-weight:900;font-size:11px;}

    tbody tr.personRow td{background:#f3f3f3;}
    tbody tr.personRow:nth-child(2n) td{background:#eaeaea;}

    .nameCell{padding:6px 10px;text-align:left;font-family:var(--sans);font-size:13px;font-weight:900;white-space:nowrap;}
    .slotCell{font-family:var(--sans);font-size:12px;font-weight:900;padding:6px 8px;text-align:left;white-space:nowrap;}

    td.code{cursor:pointer;user-select:none;font-weight:900;height:28px;line-height:28px;white-space:nowrap;}
    td.code[data-code="A"]{background:var(--a);}
    td.code[data-code="B"]{background:var(--b);}
    td.code[data-code="C"]{background:var(--c);}
    td.code[data-code="R"]{background:#e7e7e7;}
    td.code[data-code="RDO"]{background:var(--rdo);color:var(--rdoInk);}
    td.code[data-code="MDO"]{background:var(--mdo);color:var(--mdoInk);}
    td.code[data-code*="/"]{background:#fff;font-weight:1000;box-shadow:inset 0 0 0 2px #000;}
    td.code.pick{outline:3px solid #000;background:var(--pick)!important;color:#000!important;}
    td.code.swapTarget{outline:3px solid #000;background:var(--swap)!important;color:#000!important;}
    td.code.changed{box-shadow:inset 0 0 0 3px var(--warn);}

    .help{margin-top:10px;border:2px solid var(--grid);border-radius:var(--radius);padding:10px 12px;background:#fff;box-shadow:var(--shadow);font-size:12px;color:#111;line-height:1.35;font-family:var(--mono);}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="ctl">
        <div>Start Month</div>
        <input id="startMonth" type="month" />
      </div>

      <div class="ctl">
        <div>Show Months</div>
        <select id="showMonths">
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>

      <div class="ctl">
        <div>Mode</div>
        <select id="mode">
          <option value="view">View</option>
          <option value="swap">Swap</option>
          <option value="double">Double (ME only → choose MDO)</option>
        </select>
      </div>

      <button id="prevBtn">◀ Prev</button>
      <button id="nextBtn">Next ▶</button>
      <button id="thisBtn">This Month</button>

      <div class="spacer"></div>

      <div class="ctl">
        <div>ME</div>
        <select id="meSel"></select>
      </div>
      <div class="ctl">
        <div>SWAP WITH</div>
        <select id="themSel"></select>
      </div>

      <button id="resetBtn">Reset Changes</button>
      <button class="primary" id="genFormBtn" disabled>Generate Form (Print)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="statusMode">MODE: VIEW</span>
      <span class="pill" id="statusPick">PICK: —</span>
      <span class="pill" id="statusInfo">INFO: —</span>
      <div class="spacer"></div>
      <span class="pill" id="statusCoverage">COVERAGE: —</span>
    </div>

    <div class="legend">
      <span class="chip"><span class="sw b"></span> B</span>
      <span class="chip"><span class="sw a"></span> A</span>
      <span class="chip"><span class="sw c"></span> C</span>
      <span class="chip"><span class="sw rdo"></span> RDO</span>
      <span class="chip"><span class="sw mdo"></span> MDO</span>
      <span class="chip"><span class="sw pick"></span> picked</span>
      <span class="chip"><span class="sw swap"></span> swap target</span>
    </div>
  </div>

  <div class="wrap" id="monthsWrap"></div>

  <div class="wrap">
    <div class="help">
      SWAP: click a ME cell then a THEM cell (must be same Sun–Sat week).<br/>
      DOUBLE: click a ME weekday cell to create A/B or B/C, then click another ME weekday cell in the SAME week to place MDO.<br/><br/>
      Rule added (your request): you cannot move A/B/C (or doubles) onto a weekend cell if that weekend is baseline RDO for that person.
    </div>
  </div>

<script>
/* =========================
   Baseline 6-week loop
   ========================= */
const ANCHOR_DATE_ISO = "2026-01-01";
const LOOP_LEN = 42;

const SLOT_TEMPLATES = {
  1: ["R","R","RDO","RDO","RDO","MDO","C","C/A","C","C","C","C","RDO","RDO","B","B","B","B","B","B","RDO","RDO","A","A","A","A","A/C","A","MDO","RDO","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R"],
  2: ["C/A","C","C","C","C","RDO","RDO","B","B","B","B","B","B","RDO","RDO","A","A","A","A","A/C","A","MDO","RDO","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","RDO","MDO","C"],
  3: ["B","B","B","B","B","B","RDO","RDO","A","A","A","A","A/C","A","MDO","RDO","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","RDO","MDO","C","C/A","C","C","C","C","RDO","RDO"],
  4: ["RDO","A","A","A","A","A/C","A","MDO","RDO","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","RDO","MDO","C","C/A","C","C","C","C","RDO","RDO","B","B","B","B","B","B","RDO"],
  5: ["MDO","RDO","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","RDO","MDO","C","C/A","C","C","C","C","RDO","RDO","B","B","B","B","B","B","RDO","RDO","A","A","A","A","A/C","A"],
  6: ["B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","RDO","MDO","C","C/A","C","C","C","C","RDO","RDO","B","B","B","B","B","B","RDO","RDO","A","A","A","A","A/C","A","MDO","RDO","RDO","RDO","B","B","B"]
};

/* =========================
   Employees (edit as needed)
   ========================= */
const EMPLOYEES = [
  { name:"Kingston, Joseph C.", slot:1 },
  { name:"Rodriguez, Roger", slot:1 },
  { name:"Joseph, George R", slot:2 },
  { name:"Ramnarine, Ashram", slot:2 },      // fixed spelling already
  { name:"Segovia, Eduardo M", slot:3 },
  { name:"Victoria, Robert", slot:3 },
  { name:"Bouaziz, Abdelghani", slot:4 },
  { name:"Gragossian, Alan", slot:4 },       // FIXED from Alani -> Alan
  { name:"Handel, Joseph", slot:5 },
  { name:"Rakhmanov, Ravshan", slot:5 },
  { name:"Rodriguez, Alexander", slot:6 },
  { name:"Svenjak, Mark", slot:6 }
];

/* Treat R as regular B tour for coverage */
function normalizeForCoverage(token){ return token === "R" ? "B" : token; }

/* =========================
   Persistence
   ========================= */
const LS_KEY = "rotShiftSwapTool_v2_fixed";
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch(e){ return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/* =========================
   Date utils
   ========================= */
function pad2(n){ return String(n).padStart(2,"0"); }
function isoDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function isoMonth(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function parseISODate(iso){ const [y,m,dd]=iso.split("-").map(Number); return new Date(y,m-1,dd); }
function parseISOMonth(iso){ const [y,m]=iso.split("-").map(Number); return new Date(y,m-1,1); }
function addMonths(date,n){ return new Date(date.getFullYear(), date.getMonth()+n, 1); }
function daysInMonth(y,m0){ return new Date(y,m0+1,0).getDate(); }
function dowShort(d){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]; }
function isWeekend(d){ return d.getDay()===0 || d.getDay()===6; }
function isWeekday(d){ const g=d.getDay(); return g>=1 && g<=5; }
function weekStartSundayISO(iso){
  const d=parseISODate(iso);
  const ws=new Date(d.getFullYear(), d.getMonth(), d.getDate()-d.getDay());
  return isoDate(ws);
}
function sameWeek(a,b){ return weekStartSundayISO(a)===weekStartSundayISO(b); }

/* =========================
   Core schedule
   ========================= */
function getEmp(name){ return EMPLOYEES.find(e=>e.name===name)||null; }

function loopIndex(iso){
  const a=parseISODate(ANCHOR_DATE_ISO);
  const d=parseISODate(iso);
  const ms=24*60*60*1000;
  const diff=Math.floor((d-a)/ms);
  return ((diff%LOOP_LEN)+LOOP_LEN)%LOOP_LEN;
}

function baseCode(person, iso){
  const emp=getEmp(person);
  if(!emp) return "";
  const arr=SLOT_TEMPLATES[emp.slot];
  if(!arr || arr.length!==LOOP_LEN) return "";
  return arr[loopIndex(iso)] || "";
}

const state = loadState() || {
  startMonthISO: isoMonth(new Date()),
  showMonths: 3,
  mode: "view",
  me: EMPLOYEES[0]?.name || "",
  them: EMPLOYEES[1]?.name || "",
  overrides: {},            // { person: { isoDate: "CODE" } }
  pendingMDO: null          // { person, weekStartISO }
};

function getOverride(person, iso){ return state.overrides?.[person]?.[iso] ?? null; }
function setOverride(person, iso, code){
  if(!state.overrides[person]) state.overrides[person]={};
  state.overrides[person][iso]=code;
}
function delOverride(person, iso){
  if(state.overrides?.[person]) delete state.overrides[person][iso];
}
function codeFor(person, iso){ return getOverride(person, iso) ?? baseCode(person, iso); }

function isOff(code){ return code==="RDO" || code==="MDO"; }
function isWorkLike(code){ return !!code && !isOff(code); }

/* Coverage counting (2 A / 2 B / 2 C every day) */
function countTokens(code){
  const out={A:0,B:0,C:0};
  if(!code || isOff(code)) return out;
  const parts = code.split("/").map(s=>s.trim()).filter(Boolean);
  for(let p of parts){
    p=normalizeForCoverage(p);
    if(p==="A") out.A++;
    else if(p==="B") out.B++;
    else if(p==="C") out.C++;
  }
  return out;
}
function dayCoverage(iso){
  const total={A:0,B:0,C:0};
  for(const emp of EMPLOYEES){
    const add=countTokens(codeFor(emp.name, iso));
    total.A+=add.A; total.B+=add.B; total.C+=add.C;
  }
  return total;
}
function coverageOk(c){ return c.A===2 && c.B===2 && c.C===2; }

/* Week rule: 5 workdays and 2 offdays (RDO/MDO) */
function weekCounts(person, weekStartISO){
  const ws=parseISODate(weekStartISO);
  let workDays=0, offDays=0;
  for(let i=0;i<7;i++){
    const d=new Date(ws.getFullYear(), ws.getMonth(), ws.getDate()+i);
    const iso=isoDate(d);
    const c=codeFor(person, iso);
    if(isOff(c)) offDays++; else workDays++;
  }
  return {workDays, offDays};
}

/* User rule: cannot move A/B/C (or doubles) onto a weekend cell if that weekend is baseline RDO for that person */
function violatesWeekendBaselineRDO(person, iso, incomingCode){
  const d=parseISODate(iso);
  if(!isWeekend(d)) return false;
  const base = baseCode(person, iso);
  if(base !== "RDO") return false;              // only care when baseline weekend is RDO
  if(isOff(incomingCode)) return false;         // still off: fine
  return true;                                  // incoming is work-like -> block
}

/* =========================
   Swap + Double validation
   ========================= */
function validateSwap(me, them, isoMe, isoThem){
  const errors=[];
  if(!sameWeek(isoMe, isoThem)) errors.push("Cannot cross weeks (Sun–Sat).");

  const meIncoming = codeFor(them, isoThem);
  const themIncoming = codeFor(me, isoMe);

  if(violatesWeekendBaselineRDO(me, isoMe, meIncoming)) errors.push("Blocked: ME weekend is baseline RDO (cannot move work onto it).");
  if(violatesWeekendBaselineRDO(them, isoThem, themIncoming)) errors.push("Blocked: THEM weekend is baseline RDO (cannot move work onto it).");

  if(errors.length) return {ok:false, errors};

  // simulate swap and check (a) day coverage for both dates (b) week 5/2 rule for both people
  const aMe = codeFor(me, isoMe);
  const aThem = codeFor(them, isoThem);

  // temporary apply
  setOverride(me, isoMe, aThem);
  setOverride(them, isoThem, aMe);

  const cov1 = dayCoverage(isoMe);
  const cov2 = (isoMe===isoThem) ? cov1 : dayCoverage(isoThem);
  if(!coverageOk(cov1)) errors.push(`Coverage breaks on ${isoMe} (needs 2/2/2).`);
  if(!coverageOk(cov2)) errors.push(`Coverage breaks on ${isoThem} (needs 2/2/2).`);

  const ws = weekStartSundayISO(isoMe);
  const cMe = weekCounts(me, ws);
  const cTh = weekCounts(them, ws);
  if(!(cMe.workDays===5 && cMe.offDays===2)) errors.push(`ME week ${ws} must be 5 shifts + 2 off (now ${cMe.workDays}/${cMe.offDays}).`);
  if(!(cTh.workDays===5 && cTh.offDays===2)) errors.push(`THEM week ${ws} must be 5 shifts + 2 off (now ${cTh.workDays}/${cTh.offDays}).`);

  // revert temp
  delOverride(me, isoMe);
  delOverride(them, isoThem);

  if(errors.length) return {ok:false, errors};
  return {ok:true, errors:[]};
}

function doSwap(me, them, isoMe, isoThem){
  const v=validateSwap(me, them, isoMe, isoThem);
  if(!v.ok) return v;
  const a = codeFor(me, isoMe);
  const b = codeFor(them, isoThem);
  setOverride(me, isoMe, b);
  setOverride(them, isoThem, a);
  return {ok:true, errors:[]};
}

/* Double: ME weekday -> A/B or B/C; then pick MDO weekday in same week */
function proposeDouble(existing){
  if(!existing) return null;
  if(existing.includes("/")) return null; // already double
  const norm = normalizeForCoverage(existing.trim());
  if(norm==="A") return "A/B";
  if(norm==="C") return "B/C";
  if(norm==="B") return "__CHOOSE__";
  return null;
}
function chooseForB(){
  const choice = window.prompt('B day double: type "A/B" or "B/C"', "A/B");
  if(choice===null) return null;
  const cleaned=choice.trim().toUpperCase();
  return (cleaned==="A/B" || cleaned==="B/C") ? cleaned : null;
}
function canPlaceMDO(person, iso){
  const d=parseISODate(iso);
  if(!isWeekday(d)) return false;
  const c=codeFor(person, iso);
  // allow converting B/R/RDO/MDO on weekdays into MDO (simple)
  const n=normalizeForCoverage(c.trim());
  return (n==="B" || c==="RDO" || c==="MDO");
}

/* =========================
   UI / Render
   ========================= */
const monthsWrap=document.getElementById("monthsWrap");
const startMonthInput=document.getElementById("startMonth");
const showMonthsSel=document.getElementById("showMonths");
const modeSel=document.getElementById("mode");
const meSel=document.getElementById("meSel");
const themSel=document.getElementById("themSel");
const statusMode=document.getElementById("statusMode");
const statusPick=document.getElementById("statusPick");
const statusInfo=document.getElementById("statusInfo");
const statusCoverage=document.getElementById("statusCoverage");

function setPill(el, text, kind){
  el.textContent=text;
  el.classList.remove("ok","bad");
  if(kind==="ok") el.classList.add("ok");
  if(kind==="bad") el.classList.add("bad");
}

function buildSelectOptions(sel, value){
  sel.innerHTML="";
  for(const e of EMPLOYEES){
    const o=document.createElement("option");
    o.value=e.name; o.textContent=e.name;
    sel.appendChild(o);
  }
  sel.value=value;
}

function monthTitle(d){
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${months[d.getMonth()]} ${d.getFullYear()}`;
}

let pick=null; // {person, iso}

function render(){
  // controls
  startMonthInput.value = state.startMonthISO; // YYYY-MM
  showMonthsSel.value = String(state.showMonths);
  modeSel.value = state.mode;
  buildSelectOptions(meSel, state.me);
  buildSelectOptions(themSel, state.them);

  setPill(statusMode, `MODE: ${state.mode.toUpperCase()}`);
  setPill(statusPick, pick ? `PICK: ${pick.person} @ ${pick.iso}` : "PICK: —");
  setPill(statusInfo, state.pendingMDO ? `INFO: Pick MDO day (ME) in week of ${state.pendingMDO.weekStartISO}` : "INFO: —");
  document.getElementById("genFormBtn").disabled = true;

  monthsWrap.innerHTML="";
  const start=parseISOMonth(state.startMonthISO);

  let anyBad=false;

  for(let i=0;i<Number(state.showMonths);i++){
    const mDate=addMonths(start,i);
    monthsWrap.appendChild(renderMonthPanel(mDate));

    const y=mDate.getFullYear(), m0=mDate.getMonth(), dim=daysInMonth(y,m0);
    for(let d=1; d<=dim; d++){
      const iso=isoDate(new Date(y,m0,d));
      if(!coverageOk(dayCoverage(iso))) anyBad=true;
    }
  }

  setPill(statusCoverage, anyBad ? "COVERAGE: NOT 2/2/2 (see COV row)" : "COVERAGE: OK 2/2/2", anyBad ? "bad":"ok");
}

function renderMonthPanel(monthDate){
  const y=monthDate.getFullYear(), m0=monthDate.getMonth(), dim=daysInMonth(y,m0);

  const panel=document.createElement("div");
  panel.className="panel";

  const hdr=document.createElement("div");
  hdr.className="monthHeader";
  hdr.innerHTML=`<div>${monthTitle(monthDate)}</div><small>Rotating Shift</small>`;
  panel.appendChild(hdr);

  const scroll=document.createElement("div");
  scroll.className="scrollX";
  panel.appendChild(scroll);

  const table=document.createElement("table");
  scroll.appendChild(table);

  const thead=document.createElement("thead");
  table.appendChild(thead);

  // Row 1: day numbers
  const r1=document.createElement("tr");
  thead.appendChild(r1);

  const thName=document.createElement("th");
  thName.className="stickyLeft colName band";
  thName.textContent="NAME";
  r1.appendChild(thName);

  const thSlot=document.createElement("th");
  thSlot.className="stickyLeft2 colSlot band";
  thSlot.textContent="SLOT";
  r1.appendChild(thSlot);

  for(let d=1; d<=dim; d++){
    const th=document.createElement("th");
    th.className="colDay dayTop";
    th.textContent=String(d);
    r1.appendChild(th);
  }

  // Row 2: DOW
  const r2=document.createElement("tr");
  thead.appendChild(r2);

  const thN2=document.createElement("th");
  thN2.className="stickyLeft colName";
  thN2.textContent="";
  r2.appendChild(thN2);

  const thS2=document.createElement("th");
  thS2.className="stickyLeft2 colSlot";
  thS2.textContent="";
  r2.appendChild(thS2);

  for(let d=1; d<=dim; d++){
    const date=new Date(y,m0,d);
    const th=document.createElement("th");
    th.className="colDay dow";
    th.textContent=dowShort(date);
    r2.appendChild(th);
  }

  // Row 3: Coverage
  const r3=document.createElement("tr");
  thead.appendChild(r3);

  const thC1=document.createElement("th");
  thC1.className="stickyLeft colName cov";
  thC1.textContent="COV";
  r3.appendChild(thC1);

  const thC2=document.createElement("th");
  thC2.className="stickyLeft2 colSlot cov";
  thC2.textContent="(A/B/C)";
  r3.appendChild(thC2);

  for(let d=1; d<=dim; d++){
    const iso=isoDate(new Date(y,m0,d));
    const cov=dayCoverage(iso);
    const th=document.createElement("th");
    th.className="colDay cov";
    th.textContent=`${cov.A}/${cov.B}/${cov.C}`;
    if(!coverageOk(cov)){ th.style.color="var(--warn)"; th.style.fontWeight="1000"; }
    r3.appendChild(th);
  }

  const tbody=document.createElement("tbody");
  table.appendChild(tbody);

  // Put ME and THEM first (stacked) for swapping view
  if(state.me && state.them && state.me!==state.them){
    tbody.appendChild(renderPersonRow(monthDate, state.me, dim, true, "ME"));
    tbody.appendChild(renderPersonRow(monthDate, state.them, dim, true, "THEM"));
    const div=document.createElement("tr");
    const td=document.createElement("td");
    td.colSpan=2+dim;
    td.style.borderTop="4px solid #000";
    td.style.height="4px";
    td.style.padding="0";
    div.appendChild(td);
    tbody.appendChild(div);
  }

  for(const emp of EMPLOYEES){
    tbody.appendChild(renderPersonRow(monthDate, emp.name, dim, false, ""));
  }

  return panel;
}

function renderPersonRow(monthDate, person, dim, isTop, tag){
  const y=monthDate.getFullYear(), m0=monthDate.getMonth();
  const emp=getEmp(person);

  const tr=document.createElement("tr");
  tr.className="personRow";

  const tdName=document.createElement("td");
  tdName.className="stickyLeft colName nameCell";
  tdName.textContent = tag ? `${person} (${tag})` : person;
  tr.appendChild(tdName);

  const tdSlot=document.createElement("td");
  tdSlot.className="stickyLeft2 colSlot slotCell";
  tdSlot.textContent = emp ? `Slot ${emp.slot}` : "";
  tr.appendChild(tdSlot);

  for(let d=1; d<=dim; d++){
    const date=new Date(y,m0,d);
    const iso=isoDate(date);
    const c=codeFor(person, iso);

    const td=document.createElement("td");
    td.className="colDay code";
    td.dataset.person=person;
    td.dataset.iso=iso;
    td.dataset.code=c;
    td.dataset.base=baseCode(person, iso);

    td.textContent=c;
    td.setAttribute("data-code", c);

    if(getOverride(person, iso)!==null) td.classList.add("changed");

    // highlight pick / swap target in swap mode
    if(pick && pick.person===person && pick.iso===iso) td.classList.add("pick");

    td.addEventListener("click", ()=>onCellClick(td));
    tr.appendChild(td);
  }

  return tr;
}

/* =========================
   Click handlers
   ========================= */
function onCellClick(td){
  const mode=state.mode;
  const person=td.dataset.person;
  const iso=td.dataset.iso;

  if(mode==="view") return;

  // If pending MDO (double flow)
  if(mode==="double" && state.pendingMDO){
    if(person !== state.me){
      setPill(statusInfo, "INFO: MDO must be on ME row", "bad");
      return;
    }
    if(weekStartSundayISO(iso) !== state.pendingMDO.weekStartISO){
      setPill(statusInfo, "INFO: MDO must be in the same week", "bad");
      return;
    }
    if(!canPlaceMDO(state.me, iso)){
      setPill(statusInfo, "INFO: MDO must be weekday (Mon–Fri) and B/R/RDO/MDO", "bad");
      return;
    }
    setOverride(state.me, iso, "MDO");

    // validate week + day coverage after placing MDO
    const ws=state.pendingMDO.weekStartISO;
    const cMe=weekCounts(state.me, ws);
    if(!(cMe.workDays===5 && cMe.offDays===2)){
      // revert
      delOverride(state.me, iso);
      setPill(statusInfo, `INFO: Week ${ws} must be 5 shifts + 2 off (now ${cMe.workDays}/${cMe.offDays})`, "bad");
      return;
    }
    // also ensure coverage that day stays 2/2/2
    if(!coverageOk(dayCoverage(iso))){
      delOverride(state.me, iso);
      setPill(statusInfo, `INFO: Coverage breaks on ${iso} (needs 2/2/2)`, "bad");
      return;
    }

    state.pendingMDO=null;
    pick=null;
    saveState();
    setPill(statusInfo, "INFO: Double complete (MDO placed)", "ok");
    render();
    return;
  }

  if(mode==="swap"){
    // only ME/THEM rows
    if(person !== state.me && person !== state.them){
      setPill(statusInfo, "INFO: Click only ME/THEM rows", "bad");
      return;
    }

    if(!pick){
      pick={person, iso};
      setPill(statusPick, `PICK: ${pick.person} @ ${pick.iso}`);
      saveState();
      render();
      return;
    }

    // second click must be the other person
    if(pick.person === person){
      pick={person, iso}; // just re-pick
      saveState();
      render();
      return;
    }

    const isoMe  = (pick.person===state.me)   ? pick.iso : iso;
    const isoThem= (pick.person===state.them) ? pick.iso : iso;

    const res=doSwap(state.me, state.them, isoMe, isoThem);
    if(res.ok){
      pick=null;
      state.pendingMDO=null;
      saveState();
      setPill(statusInfo, "INFO: Swapped", "ok");
      render();
    }else{
      setPill(statusInfo, `INFO: ${res.errors[0]}`, "bad");
    }
    return;
  }

  if(mode==="double"){
    // only ME row
    if(person !== state.me){
      setPill(statusInfo, "INFO: Double can only be created on ME row", "bad");
      return;
    }
    const d=parseISODate(iso);
    if(!isWeekday(d)){
      setPill(statusInfo, "INFO: Double must be on a weekday (Mon–Fri)", "bad");
      return;
    }

    // also honor the "baseline weekend RDO" rule (not relevant here because weekday)
    const existing=codeFor(state.me, iso);
    const prop=proposeDouble(existing);
    if(prop===null){
      setPill(statusInfo, "INFO: Cannot double this cell", "bad");
      return;
    }
    let finalCode=prop;
    if(prop==="__CHOOSE__"){
      const chosen=chooseForB();
      if(!chosen){
        setPill(statusInfo, "INFO: Cancelled (must type A/B or B/C)", "bad");
        return;
      }
      finalCode=chosen;
    }

    // place the double
    setOverride(state.me, iso, finalCode);

    // validate coverage that day
    if(!coverageOk(dayCoverage(iso))){
      delOverride(state.me, iso);
      setPill(statusInfo, `INFO: Coverage breaks on ${iso} (needs 2/2/2)`, "bad");
      return;
    }

    // require MDO in same week
    state.pendingMDO = { person: state.me, weekStartISO: weekStartSundayISO(iso) };
    pick=null;
    saveState();
    setPill(statusInfo, `INFO: Double set (${finalCode}). Now pick MDO weekday in same week.`, "ok");
    render();
    return;
  }
}

/* =========================
   Control events
   ========================= */
document.getElementById("prevBtn").addEventListener("click", ()=>{
  const d=parseISOMonth(state.startMonthISO);
  state.startMonthISO=isoMonth(addMonths(d,-1));
  state.pendingMDO=null; pick=null; saveState(); render();
});
document.getElementById("nextBtn").addEventListener("click", ()=>{
  const d=parseISOMonth(state.startMonthISO);
  state.startMonthISO=isoMonth(addMonths(d,1));
  state.pendingMDO=null; pick=null; saveState(); render();
});
document.getElementById("thisBtn").addEventListener("click", ()=>{
  state.startMonthISO=isoMonth(new Date());
  state.pendingMDO=null; pick=null; saveState(); render();
});
startMonthInput.addEventListener("change", ()=>{
  // input gives YYYY-MM
  state.startMonthISO = startMonthInput.value || isoMonth(new Date());
  state.pendingMDO=null; pick=null; saveState(); render();
});
showMonthsSel.addEventListener("change", ()=>{
  state.showMonths=Number(showMonthsSel.value);
  saveState(); render();
});
modeSel.addEventListener("change", ()=>{
  state.mode=modeSel.value;
  state.pendingMDO=null; pick=null;
  saveState(); render();
});
meSel.addEventListener("change", ()=>{
  state.me=meSel.value;
  if(state.them===state.me){
    state.them=EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;
  }
  state.pendingMDO=null; pick=null; saveState(); render();
});
themSel.addEventListener("change", ()=>{
  state.them=themSel.value;
  if(state.them===state.me){
    state.them=EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;
  }
  state.pendingMDO=null; pick=null; saveState(); render();
});
document.getElementById("resetBtn").addEventListener("click", ()=>{
  state.overrides={};
  state.pendingMDO=null;
  pick=null;
  saveState();
  setPill(statusInfo, "INFO: Reset done", "ok");
  render();
});

/* Print form disabled for now (we’ll wire the exact supervisor form later) */
document.getElementById("genFormBtn").addEventListener("click", ()=>{});

/* =========================
   Init
   ========================= */
if(!getEmp(state.me)) state.me = EMPLOYEES[0]?.name || "";
if(!getEmp(state.them) || state.them===state.me) state.them = EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;

saveState();
render();
</script>
</body>
</html>
