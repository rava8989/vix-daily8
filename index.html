<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotating Shift — Schedule + Swap</title>
  <style>
    :root{
      --ink:#111;
      --grid:#1f1f1f;
      --hdr:#0b0b0b;
      --hdr2:#151515;

      --aBg:#1f1f1f; --aFg:#fff;         /* A */
      --bBg:#ffffff; --bFg:#111;         /* B */
      --cBg:#d9d9d9; --cFg:#111;         /* C */
      --rdoBg:#1f1f1f; --rdoFg:#fff;     /* RDO */
      --mdoBg:#bfbfbf; --mdoFg:#111;     /* MDO */
      --rBg:#ededed; --rFg:#111;         /* R */
      --holBg:#ffe8ea; --holFg:#b10014;  /* HOL */
      --toBg:#e9f2ff; --toFg:#111;       /* COMP/PE/SICK/IOD/DIF */

      --sel:#0b57d0;
      --chg:#000;
      --accent:#b10014;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, Helvetica, sans-serif; color:var(--ink); background:#fff; }

    header{
      padding:10px 12px;
      border-bottom:3px solid var(--grid);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .group{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    .field{ min-width:200px; }
    label{ display:block; font-size:12px; font-weight:900; margin:0 0 6px 2px; }
    select, input{
      width:100%;
      padding:10px 12px;
      border:2px solid var(--grid);
      border-radius:10px;
      background:#fff;
      font-weight:900;
    }
    button{
      padding:10px 12px;
      border:2px solid var(--grid);
      border-radius:10px;
      background:#fff;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    button.primary{ background:#111; color:#fff; }
    button.danger{ background:var(--accent); color:#fff; border-color:var(--accent); }
    button:hover{ opacity:.88; }

    main{ padding:10px 12px 18px; }

    .statusRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .pill{
      border:2px solid var(--grid);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      background:#fff;
      white-space:nowrap;
    }
    .pill.ok{ border-color:#1b5e20; color:#1b5e20; }
    .pill.bad{ border-color:var(--accent); color:var(--accent); }
    .pill.info{ border-color:#0b57d0; color:#0b57d0; }

    .paperWrap{
      border:2px solid var(--grid);
      border-radius:12px;
      overflow:hidden;
    }
    .paperTop{
      background:var(--hdr);
      color:#fff;
      padding:10px 12px;
      border-bottom:2px solid var(--grid);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .paperTitle{ font-weight:900; letter-spacing:.6px; }
    .paperMonth{ font-weight:900; opacity:.95; white-space:nowrap; }

    .scrollX{ overflow:auto; background:#fff; }

    table.schedule{
      border-collapse:collapse;
      width:max-content;
      min-width:100%;
      table-layout:fixed;
      font-weight:900;
    }
    table.schedule th, table.schedule td{
      border:2px solid var(--grid);
      text-align:center;
      padding:0;
    }

    .sticky{ position:sticky; left:0; z-index:3; background:#fff; }
    .sticky2{ position:sticky; left:170px; z-index:3; background:#fff; }
    .sticky3{ position:sticky; left:260px; z-index:3; background:#fff; }

    .colName{ width:170px; min-width:170px; max-width:170px; }
    .colShift{ width:90px; min-width:90px; max-width:90px; }
    .colSlot{ width:70px; min-width:70px; max-width:70px; }

    thead th{ background:var(--hdr); color:#fff; }
    .headName,.headShift,.headSlot{
      background:var(--hdr);
      color:#fff;
      font-size:12px;
      letter-spacing:.2px;
      padding:6px 8px;
    }
    .dayNum{
      width:44px; min-width:44px; max-width:44px;
      height:28px; font-size:12px;
    }
    .dayDow{
      width:44px; min-width:44px; max-width:44px;
      height:22px; font-size:11px;
      opacity:.95; background:var(--hdr2);
    }

    .rowBand{
      background:#000;
      color:#fff;
      font-size:12px;
      letter-spacing:.2px;
      padding:6px 8px;
      text-align:left;
    }

    tbody td{
      height:40px;
      width:44px; min-width:44px; max-width:44px;
      position:relative;
      user-select:none;
      cursor:pointer;
    }
    tbody tr.dataRow:nth-child(odd) td{ background:#f1f1f1; }
    tbody tr.dataRow:nth-child(even) td{ background:#e6e6e6; }

    .nameCell,.shiftCell,.slotCell{
      text-align:left;
      padding:6px 8px !important;
      background:#fff !important;
      z-index:4;
      cursor:default;
    }
    .nameCell{ font-size:12px; }
    .shiftCell,.slotCell{ font-size:12px; text-align:center; }

    .code{
      display:flex; align-items:center; justify-content:center;
      height:100%; width:100%;
      font-size:13px; letter-spacing:.3px;
      pointer-events:none;
    }

    .A{ background:var(--aBg) !important; color:var(--aFg) !important; }
    .B{ background:var(--bBg) !important; color:var(--bFg) !important; }
    .C{ background:var(--cBg) !important; color:var(--cFg) !important; }
    .RDO{ background:var(--rdoBg) !important; color:var(--rdoFg) !important; }
    .MDO{ background:var(--mdoBg) !important; color:var(--mdoFg) !important; }
    .R{ background:var(--rBg) !important; color:var(--rFg) !important; }
    .HOL{ background:var(--holBg) !important; color:var(--holFg) !important; }
    .COMP,.PE,.SICK,.IOD,.DIF{ background:var(--toBg) !important; color:var(--toFg) !important; }

    /* doubles */
    .AB,.BC{ background:#000 !important; color:#fff !important; }

    td.pick{ outline:4px solid var(--sel); outline-offset:-4px; z-index:2; }
    td.changed::after{ content:""; position:absolute; inset:0; box-shadow: inset 0 0 0 3px var(--chg); pointer-events:none; }

    .errors{
      margin-top:10px;
      border:2px solid var(--accent);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      color:var(--accent);
      white-space:pre-wrap;
      display:none;
    }

    .legend{
      margin-top:10px;
      border:2px solid var(--grid);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="group">
    <div class="field">
      <label>Month</label>
      <input id="monthPick" type="month" />
    </div>

    <div class="field" style="min-width:160px;">
      <label>Jump</label>
      <div style="display:flex; gap:8px;">
        <button id="prev">◀ Prev</button>
        <button id="next">Next ▶</button>
        <button id="thisMonth" class="primary">This Month</button>
      </div>
    </div>

    <div class="field" style="min-width:170px;">
      <label>Mode</label>
      <select id="mode">
        <option value="swap" selected>Swap</option>
        <option value="double">Add Double</option>
        <option value="view">View</option>
      </select>
    </div>

    <div class="field" style="min-width:170px;">
      <label>Double Type</label>
      <select id="doubleType">
        <option value="AB">A/B</option>
        <option value="BC">B/C</option>
      </select>
    </div>
  </div>

  <div class="group">
    <div class="field">
      <label>ME</label>
      <select id="me"></select>
    </div>
    <div class="field">
      <label>SWAP WITH</label>
      <select id="them"></select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="resetSwaps">Reset Swaps</button>
      <button id="generateForm" class="primary">Generate Form (Print)</button>
      <button id="lockBaseline" class="danger">Lock Baseline</button>
      <button id="resetBaseline">Reset Baseline</button>
    </div>
  </div>
</header>

<main>
  <div class="statusRow">
    <span class="pill info" id="hintPill">Swap: click a day on ME, then a day on THEM (must be same week Sun–Sat).</span>
    <span class="pill" id="baselinePill">BASELINE: NOT LOCKED</span>
    <span class="pill" id="validPill">VALIDATION: —</span>
  </div>

  <div class="paperWrap">
    <div class="paperTop">
      <div class="paperTitle">MONTHLY LABOR SCHEDULE — ROTATING SHIFT (MID SECTION)</div>
      <div class="paperMonth" id="paperMonthText"></div>
    </div>
    <div class="scrollX" id="tableHost"></div>
  </div>

  <div class="errors" id="errors"></div>

  <div class="legend">
Legend:
A = night, B = day, C = evening, R = reserve (treated like B)
RDO = regular day off, MDO = mutual day off
HOL = holiday
COMP = comp time, PE = personal excuse, SICK = sick leave, IOD = injury on duty, DIF = death in family
A/B and B/C are doubles

Rules enforced:
1) NO cross-week swaps. Any swap must stay inside the same week (Sunday–Saturday).
2) “Fixed coverage days” cannot be moved to a different date:
   • A, C, HOL, and weekend B (Sat/Sun) MUST be swapped same-date (ME day must equal THEM day).
   (So coverage stays on that exact day; it only changes WHO works it.)
3) Regular weekday B can move only inside the same week, but it cannot be moved onto Sat/Sun or onto a HOL day.
4) Add Double: click a day for the person to mark it A/B or B/C; system will automatically convert one weekday RDO in that same week into MDO (required). If no weekday RDO exists in that week, it blocks the double.
  </div>
</main>

<script>
/* ===========================
   DATA — EDIT THIS LIST
   =========================== */
const EMPLOYEES = [
  { name: "Kingston, Joseph C", slot: 1, shift: "LGA_6RR9.1" },
  { name: "Rodriguez, Roger", slot: 1, shift: "LGA_6RR9.1" },

  { name: "Joseph, George R", slot: 2, shift: "LGA_6RR9.2" },
  { name: "Ramanrane, Ashram", slot: 2, shift: "LGA_6RR9.2" },

  { name: "Segovia, Eduardo M", slot: 3, shift: "LGA_6RR9.3" },
  { name: "Victoria, Robert", slot: 3, shift: "LGA_6RR9.3" },

  { name: "Bouaziz, Abdelghani", slot: 4, shift: "LGA_6RR9.4" },
  { name: "Gragossian, Alani", slot: 4, shift: "LGA_6RR9.4" },

  { name: "Handel, Joseph", slot: 5, shift: "LGA_6RR9.5" },
  { name: "Rakhmanov, Ravshan", slot: 5, shift: "LGA_6RR9.5" },

  { name: "Rodriguez, Alexander", slot: 6, shift: "LGA_6RR9.6" },
  { name: "Svenjak, Mark", slot: 6, shift: "LGA_6RR9.6" },
];

const TIME_OFF = new Set(["HOL","COMP","PE","SICK","IOD","DIF"]);
const WORK = new Set(["A","B","C","R","AB","BC"]);

const K_BASELINE = "pa_rot_baseline_42";
const K_BASELINE_LOCKED = "pa_rot_baseline_locked";
const K_SWAPS = "pa_rot_swaps_v2";

const pad2 = (n)=>String(n).padStart(2,"0");
const isoDate = (y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
const daysInMonth = (y,m)=>new Date(y,m,0).getDate();
const monthLabel = (y,m)=>new Date(y,m-1,1).toLocaleString(undefined,{month:"long",year:"numeric"});
const startOfDay = (iso)=>{ const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return d; };
const daysBetween = (aISO,bISO)=>Math.floor((startOfDay(bISO)-startOfDay(aISO))/(24*60*60*1000));
const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

/* SLOT 1 default 42-day loop (edit later if needed) */
const DEFAULT_BASELINE_42 = [
  "RDO","B","B","B","B","B","RDO",
  "RDO","A","A","A","A","A","RDO",
  "RDO","C","C","C","C","C","RDO",
  "RDO","B","B","B","B","B","RDO",
  "RDO","A","A","A","A","A","RDO",
  "RDO","C","C","C","C","C","RDO",
];

const CYCLE_START = "2026-01-04";
const CYCLE_LEN = 42;

function norm(code){ return (code ?? "").toString().trim().toUpperCase(); }

function loadBaseline(){
  const locked = localStorage.getItem(K_BASELINE_LOCKED) === "1";
  const raw = localStorage.getItem(K_BASELINE);
  if(raw){
    try{
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length === 42) return { locked, arr };
    }catch{}
  }
  return { locked:false, arr:[...DEFAULT_BASELINE_42] };
}
function saveBaseline(arr){
  localStorage.setItem(K_BASELINE, JSON.stringify(arr));
  localStorage.setItem(K_BASELINE_LOCKED, "1");
}
function resetBaseline(){
  localStorage.removeItem(K_BASELINE);
  localStorage.removeItem(K_BASELINE_LOCKED);
}

function loadSwaps(){
  const raw = localStorage.getItem(K_SWAPS);
  if(!raw) return {};
  try{
    const obj = JSON.parse(raw);
    return obj && typeof obj==="object" ? obj : {};
  }catch{
    return {};
  }
}
function saveSwaps(obj){ localStorage.setItem(K_SWAPS, JSON.stringify(obj)); }
function resetSwaps(){ localStorage.removeItem(K_SWAPS); }

function codeFromBaseline(dateISO, slot, baseline42){
  const days = daysBetween(CYCLE_START, dateISO);
  const offset = (slot-1)*7;
  const idx = ((days+offset)%CYCLE_LEN + CYCLE_LEN) % CYCLE_LEN;
  return norm(baseline42[idx]);
}

function buildBaseMap(personIdx, y, m, baseline42){
  const p = EMPLOYEES[personIdx];
  const dim = daysInMonth(y,m);
  const map = new Map();
  for(let d=1; d<=dim; d++){
    const iso = isoDate(y,m,d);
    map.set(iso, codeFromBaseline(iso, p.slot, baseline42));
  }
  return map;
}
function applyOverrides(personIdx, baseMap, swapsObj){
  const out = new Map(baseMap);
  const key = String(personIdx);
  if(swapsObj[key]){
    for(const [iso, code] of Object.entries(swapsObj[key])){
      if(out.has(iso)) out.set(iso, norm(code));
    }
  }
  return out;
}
function setOverride(swapsObj, personIdx, iso, code){
  const key = String(personIdx);
  swapsObj[key] = swapsObj[key] || {};
  swapsObj[key][iso] = norm(code);
}
function clearOverride(swapsObj, personIdx, iso){
  const key = String(personIdx);
  if(swapsObj[key] && swapsObj[key][iso] != null) delete swapsObj[key][iso];
}

function dowOfISO(iso){ return new Date(iso+"T00:00:00").getDay(); } // 0=Sun
function isWeekendISO(iso){ const d=dowOfISO(iso); return d===0 || d===6; }
function weekStartISO(iso){
  const d = new Date(iso+"T00:00:00");
  const dow = d.getDay();
  d.setDate(d.getDate()-dow);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function sameWeek(aISO,bISO){ return weekStartISO(aISO) === weekStartISO(bISO); }

function codeClass(code){
  const c = norm(code);
  const ok = ["A","B","C","RDO","MDO","R","HOL","COMP","PE","SICK","IOD","DIF","AB","BC"];
  return ok.includes(c) ? c : "";
}

function validateMonth(personIdx, y, m, reqMap){
  const errs = [];
  const dim = daysInMonth(y,m);
  const buckets = new Map();
  for(let d=1; d<=dim; d++){
    const iso = isoDate(y,m,d);
    const wk = weekStartISO(iso);
    const arr = buckets.get(wk) || [];
    arr.push(iso);
    buckets.set(wk, arr);
  }
  for(const [wk, arr] of buckets.entries()){
    let shifts=0, rdo=0, hasTO=false;
    for(const iso of arr){
      const c = norm(reqMap.get(iso));
      if(TIME_OFF.has(c)) hasTO=true;
      if(c==="RDO") rdo++;
      if(WORK.has(c)) shifts++;
    }
    if(!hasTO){
      if(rdo !== 2) errs.push(`Week ${wk}: ${EMPLOYEES[personIdx].name} must have 2 RDO (found ${rdo})`);
      if(shifts !== 5) errs.push(`Week ${wk}: ${EMPLOYEES[personIdx].name} must have 5 shifts (found ${shifts})`);
    }
  }
  return errs;
}

/* ===========================
   RULE HELPERS
   =========================== */
function isFixedCoverage(code, iso){
  const c = norm(code);
  if(c==="A" || c==="C" || c==="HOL") return true;
  if(c==="B" && isWeekendISO(iso)) return true; // weekend B fixed-date
  return false;
}
function isRegularWeekdayB(code, iso){
  return norm(code)==="B" && !isWeekendISO(iso);
}
function wouldMoveWeekdayBToInvalidDay(fromISO, toISO, fromCode, toTargetCode){
  // When we move B to another day via swap: that other day must be weekday and not HOL
  // We apply this as: if either resulting placement is weekday B but on weekend/HOL => block.
  // We'll just block ANY swap that would place a B onto weekend OR onto a HOL day.
  const fromIsB = norm(fromCode)==="B";
  const toIsB = norm(toTargetCode)==="B";
  if(fromIsB && (isWeekendISO(toISO))) return true;
  if(toIsB && (isWeekendISO(fromISO))) return true;
  return false;
}

/* ===========================
   UI
   =========================== */
const elMonthPick = document.getElementById("monthPick");
const elMe = document.getElementById("me");
const elThem = document.getElementById("them");
const elMode = document.getElementById("mode");
const elDoubleType = document.getElementById("doubleType");

const elTableHost = document.getElementById("tableHost");
const elPaperMonthText = document.getElementById("paperMonthText");
const elErrors = document.getElementById("errors");

const baselinePill = document.getElementById("baselinePill");
const validPill = document.getElementById("validPill");
const hintPill = document.getElementById("hintPill");

let pick = null; // { side:"me"|"them", iso }

function initSelectors(){
  elMe.innerHTML = "";
  elThem.innerHTML = "";
  EMPLOYEES.forEach((p, i)=>{
    const o1 = document.createElement("option");
    o1.value = String(i);
    o1.textContent = `${p.name} (Slot ${p.slot})`;
    elMe.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value = String(i);
    o2.textContent = `${p.name} (Slot ${p.slot})`;
    elThem.appendChild(o2);
  });
  elMe.value = "0";
  elThem.value = "1";
}

function render(){
  const [y,m] = elMonthPick.value.split("-").map(Number);
  elPaperMonthText.textContent = monthLabel(y,m);

  const mode = elMode.value;
  hintPill.textContent =
    mode==="swap"   ? "Swap: click a day on ME, then a day on THEM (same week Sun–Sat; fixed coverage days require same-date swap)."
  : mode==="double" ? "Double: click a day on ME or THEM to mark it A/B or B/C; app auto-creates one MDO (weekday) in that same week."
  : "View: no actions.";

  const baseObj = loadBaseline();
  baselinePill.textContent = `BASELINE: ${baseObj.locked ? "LOCKED" : "NOT LOCKED"}`;
  baselinePill.className = "pill " + (baseObj.locked ? "ok" : "bad");

  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);

  const swapsObj = loadSwaps();

  const baseMe = buildBaseMap(meIdx, y, m, baseObj.arr);
  const baseTh = buildBaseMap(thIdx, y, m, baseObj.arr);
  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);
  const reqTh = applyOverrides(thIdx, baseTh, swapsObj);

  const dim = daysInMonth(y,m);

  const errs = [
    ...validateMonth(meIdx, y, m, reqMe),
    ...validateMonth(thIdx, y, m, reqTh),
  ];
  if(errs.length === 0){
    validPill.textContent = "VALIDATION: OK";
    validPill.className = "pill ok";
    elErrors.style.display="none";
    elErrors.textContent="";
  }else{
    validPill.textContent = `VALIDATION: ${errs.length} ISSUE(S)`;
    validPill.className = "pill bad";
    elErrors.style.display="block";
    elErrors.textContent = errs.map(e=>"• "+e).join("\n");
  }

  let html = `<table class="schedule" aria-label="Rotating shift schedule">
    <thead>
      <tr>
        <th class="headName sticky colName" rowspan="2">NAME</th>
        <th class="headShift sticky2 colShift" rowspan="2">SHIFT</th>
        <th class="headSlot sticky3 colSlot" rowspan="2">SLOT</th>
        ${Array.from({length:dim}, (_,i)=>`<th class="dayNum">${i+1}</th>`).join("")}
      </tr>
      <tr>
        ${Array.from({length:dim}, (_,i)=>{
          const d=i+1;
          const dow = new Date(y,m-1,d).getDay();
          return `<th class="dayDow">${DOW[dow]}</th>`;
        }).join("")}
      </tr>
    </thead>
    <tbody>
      <tr><td class="rowBand sticky colName" colspan="${3+dim}">ME</td></tr>
      ${renderPersonRow("me", meIdx, y, m, dim, baseMe, reqMe)}
      <tr><td class="rowBand sticky colName" colspan="${3+dim}">THEM</td></tr>
      ${renderPersonRow("them", thIdx, y, m, dim, baseTh, reqTh)}
    </tbody>
  </table>`;

  elTableHost.innerHTML = html;
}

function renderPersonRow(side, personIdx, y, m, dim, baseMap, reqMap){
  const p = EMPLOYEES[personIdx];
  let row = `<tr class="dataRow">
    <td class="nameCell sticky colName">${p.name}</td>
    <td class="shiftCell sticky2 colShift">${p.shift || ""}</td>
    <td class="slotCell sticky3 colSlot">${p.slot}</td>
  `;
  for(let d=1; d<=dim; d++){
    const iso = isoDate(y,m,d);
    const code = norm(reqMap.get(iso));
    const base = norm(baseMap.get(iso));
    const picked = (pick && pick.side===side && pick.iso===iso) ? "pick" : "";
    const changed = (code !== base) ? "changed" : "";
    row += `<td class="${picked} ${changed}" data-side="${side}" data-iso="${iso}">
      <div class="code ${codeClass(code)}">${code}</div>
    </td>`;
  }
  row += `</tr>`;
  return row;
}

/* ===========================
   SWAP LOGIC (with rules)
   =========================== */
function ruleCheckSwapOrThrow(ctx){
  // ctx: { isoMe, isoTh, meCode, thCode, y, m, baseMe, baseTh, reqMe, reqTh }
  const { isoMe, isoTh, meCode, thCode, reqMe, reqTh } = ctx;

  // Rule 1: same week only
  if(!sameWeek(isoMe, isoTh)){
    throw new Error("NO CROSS-WEEK swaps. Both selections must be inside the same week (Sun–Sat).");
  }

  // Identify if either side is fixed coverage on their selected date
  const meFixed = isFixedCoverage(meCode, isoMe);
  const thFixed = isFixedCoverage(thCode, isoTh);

  // Rule 2: fixed coverage days require SAME DATE swap (date-locked)
  if((meFixed || thFixed) && (isoMe !== isoTh)){
    throw new Error("Fixed coverage days (A, C, HOL, weekend B) MUST be swapped same-date (ME day must equal THEM day).");
  }

  // Rule 3: regular weekday B cannot be moved to weekend or HOL day.
  // We enforce this on the RESULT of swap:
  // After swap, ME@isoMe becomes thCode, THEM@isoTh becomes meCode.
  const meAfter = thCode;
  const thAfter = meCode;

  // Disallow placing a B onto weekend
  if(norm(meAfter)==="B" && isWeekendISO(isoMe)) throw new Error("You cannot move a regular B onto a weekend day (Sat/Sun).");
  if(norm(thAfter)==="B" && isWeekendISO(isoTh)) throw new Error("You cannot move a regular B onto a weekend day (Sat/Sun).");

  // Disallow creating weekday-B on a HOL day (treat HOL as date-locked)
  // If destination is HOL, you shouldn't be turning it into B via cross-date move.
  // Same-date swap of HOL is allowed (HOL stays on that date but changes who has it).
  if(norm(reqMe.get(isoMe))==="HOL" && norm(meAfter)==="B" && isoMe!==isoTh) throw new Error("B cannot be moved onto a HOL day.");
  if(norm(reqTh.get(isoTh))==="HOL" && norm(thAfter)==="B" && isoMe!==isoTh) throw new Error("B cannot be moved onto a HOL day.");
}

function doSwap(isoMe, isoTh){
  const [y,m] = elMonthPick.value.split("-").map(Number);
  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);

  const baseObj = loadBaseline();
  const swapsObj = loadSwaps();

  const baseMe = buildBaseMap(meIdx, y, m, baseObj.arr);
  const baseTh = buildBaseMap(thIdx, y, m, baseObj.arr);
  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);
  const reqTh = applyOverrides(thIdx, baseTh, swapsObj);

  const meCode = norm(reqMe.get(isoMe));
  const thCode = norm(reqTh.get(isoTh));

  ruleCheckSwapOrThrow({ isoMe, isoTh, meCode, thCode, y, m, baseMe, baseTh, reqMe, reqTh });

  // Swap
  setOverride(swapsObj, meIdx, isoMe, thCode);
  setOverride(swapsObj, thIdx, isoTh, meCode);

  // Clean if equals baseline
  if(norm(thCode) === norm(baseMe.get(isoMe))) clearOverride(swapsObj, meIdx, isoMe);
  if(norm(meCode) === norm(baseTh.get(isoTh))) clearOverride(swapsObj, thIdx, isoTh);

  saveSwaps(swapsObj);
}

/* ===========================
   DOUBLE LOGIC
   =========================== */
function addDouble(side, iso){
  const [y,m] = elMonthPick.value.split("-").map(Number);
  const personIdx = side==="me" ? Number(elMe.value) : Number(elThem.value);

  const baseObj = loadBaseline();
  const swapsObj = loadSwaps();

  const baseMap = buildBaseMap(personIdx, y, m, baseObj.arr);
  const reqMap = applyOverrides(personIdx, baseMap, swapsObj);

  const cur = norm(reqMap.get(iso));
  if(TIME_OFF.has(cur) || cur==="HOL"){
    throw new Error("Cannot add a double on HOL or time-off days.");
  }
  if(cur==="RDO" || cur==="MDO"){
    throw new Error("Cannot add a double on an RDO/MDO day. Pick a working day.");
  }
  if(cur==="AB" || cur==="BC"){
    throw new Error("That day is already a double.");
  }

  const dbl = elDoubleType.value; // "AB" or "BC"
  // Only allow AB if baseline-like day is A or B; allow BC if B or C.
  if(dbl==="AB" && !(cur==="A" || cur==="B" || cur==="R")){
    throw new Error("A/B double is only valid on an A or B (or R) day.");
  }
  if(dbl==="BC" && !(cur==="B" || cur==="C" || cur==="R")){
    throw new Error("B/C double is only valid on a B or C (or R) day.");
  }

  // Set the double code on selected day
  setOverride(swapsObj, personIdx, iso, dbl);

  // Required: create 1 MDO for that week (prefer converting a WEEKDAY RDO to MDO)
  const wkStart = weekStartISO(iso);
  const wkStartDate = new Date(wkStart+"T00:00:00");

  // Get all 7 isos for week
  const weekIsos = [];
  for(let i=0;i<7;i++){
    const d = new Date(wkStartDate);
    d.setDate(d.getDate()+i);
    const wiso = d.toISOString().slice(0,10);
    // Only apply if same month (this UI is single month). If week spills, still allow IF that date exists in this month map.
    if(reqMap.has(wiso)) weekIsos.push(wiso);
  }

  // Find weekday RDO candidate (Mon–Fri)
  let mdoTarget = null;
  for(const wiso of weekIsos){
    const dow = dowOfISO(wiso);
    if(dow===0 || dow===6) continue; // skip weekend
    const c = norm(applyOverrides(personIdx, baseMap, swapsObj).get(wiso));
    if(c==="RDO"){
      mdoTarget = wiso;
      break;
    }
  }
  if(!mdoTarget){
    // rollback double
    clearOverride(swapsObj, personIdx, iso);
    throw new Error("Double requires an MDO that week, but there is no weekday RDO available to convert into MDO.");
  }

  setOverride(swapsObj, personIdx, mdoTarget, "MDO");

  // Clean overrides if equal baseline
  const baseDouble = norm(baseMap.get(iso));
  if(norm(dbl) === baseDouble) clearOverride(swapsObj, personIdx, iso);

  const baseMDO = norm(baseMap.get(mdoTarget));
  if("MDO" === baseMDO) clearOverride(swapsObj, personIdx, mdoTarget);

  saveSwaps(swapsObj);
}

/* ===========================
   PRINT FORM (basic)
   =========================== */
function openFormPrint(){
  const [y,m] = elMonthPick.value.split("-").map(Number);
  const dim = daysInMonth(y,m);

  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);
  const me = EMPLOYEES[meIdx];
  const th = EMPLOYEES[thIdx];

  const baseObj = loadBaseline();
  const swapsObj = loadSwaps();

  const baseMe = buildBaseMap(meIdx, y, m, baseObj.arr);
  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);

  function gridLine(map){
    let out = "";
    for(let d=1; d<=31; d++){
      const iso = isoDate(y,m,d);
      const code = (d<=dim) ? (norm(map.get(iso))||"") : "";
      out += `<div class="cell"><div class="n">${d}</div><div class="c">${code}</div></div>`;
    }
    return out;
  }

  const today = new Date();
  const dateStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;

  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><title>Swap Form</title>
    <style>
      @page{ size: letter; margin: 0.45in; }
      body{ font-family: Arial; }
      .wrap{ position:relative; width:100%; height:10.2in; }
      .rightTitle{
        position:absolute; right:-1.75in; top:2.2in;
        transform: rotate(90deg);
        font-weight:900; letter-spacing:1px; font-size:20px;
      }
      .rightNote{
        position:absolute; right:-1.65in; top:0.9in;
        transform: rotate(90deg);
        color:#b10014; font-weight:900; font-size:12px;
      }
      .leftNote{
        position:absolute; left:-1.35in; top:0.9in;
        transform: rotate(-90deg);
        color:#b10014; font-weight:900; font-size:12px;
      }
      .dateTop{ position:absolute; right:0; top:0; font-weight:900; font-size:12px; }
      .topFields{ margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      .field{ font-size:12px; font-weight:900; }
      .line{ border-bottom:2px solid #222; height:18px; }
      .section{ margin-top:18px; display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
      .gridTitle{ font-weight:900; text-align:center; margin-bottom:6px; }
      .grid{
        display:grid; grid-template-columns: repeat(31, 1fr);
        border:2px solid #222;
      }
      .cell{
        border-right:1px solid #222;
        border-bottom:1px solid #222;
        height:26px; position:relative;
      }
      .cell .n{ position:absolute; top:2px; left:3px; font-size:10px; font-weight:900; }
      .cell .c{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; }
      .bottom{ position:absolute; bottom:0.35in; left:0; right:0; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:18px; }
    </style>
    </head><body>
      <div class="wrap">
        <div class="dateTop">DATE: ${dateStr}</div>
        <div class="rightTitle">TIME OFF OR SHIFT CHANGE REQUEST</div>
        <div class="rightNote">THIS REQUEST IS NOT APPROVED UNTIL YOU RECEIVE A SIGNED COPY OF THIS FORM</div>
        <div class="leftNote">** ALL REQUESTS WILL ONLY BE APPROVED AND SCHEDULED ON TUESDAY & THURSDAY **  8/12/2019</div>

        <div class="topFields">
          <div class="field">TO: SUPERVISOR<div class="line"></div></div>
          <div class="field">FROM:<div class="line"></div></div>
          <div class="field">MONTH:<div class="line">${y}-${String(m).padStart(2,"0")}</div></div>
          <div class="field"></div>
        </div>

        <div class="section">
          <div>
            <div class="field">NAME<div class="line">${me.name}</div></div>
            <div class="gridTitle">MY PRESENT SCHEDULE IS</div>
            <div class="grid">${gridLine(baseMe)}</div>
          </div>

          <div>
            <div class="field">NAME<div class="line">${me.name} (swap with: ${th.name})</div></div>
            <div class="gridTitle">TIME OFF OR CHANGE PERIOD REQUESTED</div>
            <div class="grid">${gridLine(reqMe)}</div>
          </div>
        </div>

        <div class="bottom">
          <div class="field">ENTERED INTO COMPUTER<div class="line"></div></div>
          <div class="field">SUPERVISOR<div class="line"></div></div>
          <div class="field">DATE<div class="line"></div></div>
        </div>
      </div>
      <script>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

/* ===========================
   EVENTS
   =========================== */
document.getElementById("prev").addEventListener("click", ()=>{
  const [y,m] = elMonthPick.value.split("-").map(Number);
  const dt = new Date(y, m-2, 1);
  elMonthPick.value = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
  pick=null; render();
});
document.getElementById("next").addEventListener("click", ()=>{
  const [y,m] = elMonthPick.value.split("-").map(Number);
  const dt = new Date(y, m, 1);
  elMonthPick.value = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}`;
  pick=null; render();
});
document.getElementById("thisMonth").addEventListener("click", ()=>{
  const now = new Date();
  elMonthPick.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  pick=null; render();
});

document.getElementById("resetSwaps").addEventListener("click", ()=>{ resetSwaps(); pick=null; render(); });
document.getElementById("lockBaseline").addEventListener("click", ()=>{
  const b = loadBaseline().arr;
  saveBaseline(b);
  pick=null; render();
});
document.getElementById("resetBaseline").addEventListener("click", ()=>{ resetBaseline(); pick=null; render(); });
document.getElementById("generateForm").addEventListener("click", ()=>{ openFormPrint(); });

elMonthPick.addEventListener("change", ()=>{ pick=null; render(); });
elMe.addEventListener("change", ()=>{ pick=null; render(); });
elThem.addEventListener("change", ()=>{ pick=null; render(); });
elMode.addEventListener("change", ()=>{ pick=null; render(); });
elDoubleType.addEventListener("change", ()=>{ /* no-op */ });

document.addEventListener("click", (e)=>{
  const td = e.target.closest("td[data-side][data-iso]");
  if(!td) return;

  const side = td.getAttribute("data-side");
  const iso = td.getAttribute("data-iso");
  const mode = elMode.value;

  if(mode === "view") return;

  // Double mode: one-click action
  if(mode === "double"){
    try{
      addDouble(side, iso);
      pick=null;
      render();
    }catch(err){
      document.getElementById("errors").style.display="block";
      document.getElementById("errors").textContent = "• " + (err?.message || String(err));
    }
    return;
  }

  // Swap mode: pick ME then THEM
  if(!pick){
    pick = { side, iso };
    render();
    return;
  }
  if(pick.side === side){
    pick = { side, iso };
    render();
    return;
  }

  const isoMe = (pick.side==="me") ? pick.iso : iso;
  const isoTh = (pick.side==="them") ? pick.iso : iso;

  try{
    doSwap(isoMe, isoTh);
    pick=null;
    render();
  }catch(err){
    pick=null;
    render();
    document.getElementById("errors").style.display="block";
    document.getElementById("errors").textContent = "• " + (err?.message || String(err));
  }
});

/* ===========================
   BOOT
   =========================== */
(function boot(){
  initSelectors();
  const now = new Date();
  elMonthPick.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  render();
})();
</script>
</body>
</html>
