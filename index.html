<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotating Shift Swap Tool</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111;
      --muted:#666;
      --grid:#1a1a1a;
      --hdr:#0b0b0b;
      --hdr2:#151515;

      --cell:#f3f3f3;
      --cell2:#eaeaea;
      --wknd:#0b0b0b;
      --wkndInk:#fff;

      --a:#cfcfcf;
      --b:#f8f8f8;
      --c:#dedede;

      --rdo:#0b0b0b;
      --rdoInk:#fff;

      --mdo:#bfbfbf;
      --mdoInk:#111;

      --hol:#ffffff;
      --holInk:#b30000;

      --warn:#b30000;
      --ok:#0a7a00;

      --accent:#1a1a1a;
      --accent2:#b30000;

      --pick:#ffe08a;
      --swap:#98d7ff;

      --shadow: 0 2px 10px rgba(0,0,0,.08);
      --radius: 10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{background:var(--bg); color:var(--ink); margin:0; font-family:var(--sans);}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:var(--bg); border-bottom:2px solid var(--grid);
      padding:10px 12px;
    }
    .row{display:flex; gap:10px; align-items:end; flex-wrap:wrap;}
    .row .spacer{flex:1}
    .ctl{
      display:flex; flex-direction:column; gap:4px;
      font-size:12px; color:var(--muted);
    }
    .ctl input,.ctl select{
      font-size:14px; padding:8px 10px;
      border:2px solid var(--grid); border-radius:8px;
      background:#fff; color:var(--ink);
      min-width:160px;
    }
    .monthRow{display:flex; gap:8px;}
    button{
      font-size:14px;
      padding:10px 12px;
      border:2px solid var(--grid);
      background:#fff;
      border-radius:999px;
      cursor:pointer;
    }
    button.primary{
      background:var(--hdr);
      color:#fff;
    }
    button.danger{
      background:var(--accent2);
      color:#fff;
      border-color:var(--accent2);
    }
    button:disabled{opacity:.55; cursor:not-allowed;}
    .pill{
      font-size:12px; padding:6px 10px;
      border:2px solid var(--grid); border-radius:999px;
      background:#fff;
    }
    .pill.ok{border-color:var(--ok); color:var(--ok);}
    .pill.bad{border-color:var(--warn); color:var(--warn);}
    .legend{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:10px;
      font-size:12px;
    }
    .chip{
      border:2px solid var(--grid); border-radius:999px;
      padding:4px 10px; display:flex; align-items:center; gap:8px;
      background:#fff;
    }
    .sw{width:16px; height:12px; border:2px solid var(--grid); border-radius:4px;}
    .sw.a{background:var(--a);}
    .sw.b{background:var(--b);}
    .sw.c{background:var(--c);}
    .sw.rdo{background:var(--rdo);}
    .sw.mdo{background:var(--mdo);}
    .sw.hol{background:var(--hol);}
    .sw.pick{background:var(--pick);}
    .sw.swap{background:var(--swap);}

    .wrap{padding:12px;}
    .panel{
      border:2px solid var(--grid);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      background:#fff;
      margin-bottom:12px;
    }

    .monthHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      background:linear-gradient(0deg, var(--hdr), var(--hdr2));
      color:#fff;
      font-weight:700;
    }
    .monthHeader small{opacity:.85; font-weight:600;}
    .scrollX{overflow:auto;}
    table{
      border-collapse:collapse;
      width:max-content;
      min-width:100%;
      table-layout:fixed;
      font-family:var(--mono);
      font-size:12px;
    }
    th,td{
      border:1px solid var(--grid);
      padding:0;
      text-align:center;
      vertical-align:middle;
    }

    th.stickyLeft, td.stickyLeft{
      position:sticky; left:0; z-index:5;
      background:#fff;
    }
    th.stickyLeft2, td.stickyLeft2{
      position:sticky; left:240px; z-index:5;
      background:#fff;
    }

    .colName{width:240px; min-width:240px; max-width:240px;}
    .colSlot{width:80px; min-width:80px; max-width:80px;}
    .colDay{width:36px; min-width:36px; max-width:36px;}

    thead th{background:#fff; font-weight:800;}
    thead .band{
      background:var(--hdr);
      color:#fff;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    thead .dayTop{
      background:var(--hdr);
      color:#fff;
      font-weight:900;
      font-size:12px;
    }
    thead .dow{
      background:#111;
      color:#fff;
      font-weight:800;
      font-size:11px;
    }

    tbody tr.personRow td{background:var(--cell);}
    tbody tr.personRow:nth-child(2n) td{background:var(--cell2);}

    td.code{
      cursor:pointer;
      user-select:none;
      font-weight:900;
      height:28px;
      line-height:28px;
    }

    td.code[data-code="A"]{background:var(--a);}
    td.code[data-code="B"]{background:var(--b);}
    td.code[data-code="C"]{background:var(--c);}
    td.code[data-code="R"]{background:#e7e7e7;}
    td.code[data-code="RDO"]{background:var(--rdo); color:var(--rdoInk);}
    td.code[data-code="MDO"]{background:var(--mdo); color:var(--mdoInk);}
    td.code[data-code="HOL"]{background:var(--hol); color:var(--holInk); font-weight:1000;}
    td.code[data-code="COMP"],
    td.code[data-code="PE"],
    td.code[data-code="SICK"],
    td.code[data-code="IOD"],
    td.code[data-code="DIF"]{
      background:#fff; color:#b30000; font-weight:1000;
    }

    td.code.wknd{background:var(--wknd) !important; color:var(--wkndInk) !important;}
    td.code.wknd[data-code="HOL"]{color:#ff9a9a !important;}

    td.code.pick{outline:3px solid #000; background:var(--pick) !important; color:#000 !important;}
    td.code.swapTarget{outline:3px solid #000; background:var(--swap) !important; color:#000 !important;}
    td.code.changed{box-shadow: inset 0 0 0 3px #b30000;}
    td.code.invalid{box-shadow: inset 0 0 0 3px var(--warn);}
    td.code.valid{box-shadow: inset 0 0 0 3px var(--ok);}

    .nameCell{
      padding:6px 10px;
      text-align:left;
      font-family:var(--sans);
      font-size:13px;
      font-weight:800;
      white-space:nowrap;
    }
    .slotCell{
      font-family:var(--sans);
      font-size:12px;
      font-weight:900;
      padding:6px 8px;
      text-align:left;
      white-space:nowrap;
    }

    .groupDivider td{
      background:#fff;
      border-top:4px solid #000;
      height:4px;
      padding:0;
    }

    .help{
      margin-top:10px;
      border:2px solid var(--grid);
      border-radius:var(--radius);
      padding:10px 12px;
      background:#fff;
      box-shadow:var(--shadow);
      font-size:12px;
      color:#111;
      line-height:1.35;
    }
    .help b{font-weight:900;}
    .help .note{color:var(--muted)}
    .help .bad{color:var(--warn); font-weight:900;}
    .help .ok{color:var(--ok); font-weight:900;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="ctl">
        <div>Start Month</div>
        <div class="monthRow">
          <select id="startMonthSel"></select>
          <select id="startYearSel"></select>
        </div>
      </div>

      <div class="ctl">
        <div>Show Months</div>
        <select id="showMonths">
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>

      <div class="ctl">
        <div>Mode</div>
        <select id="mode">
          <option value="view">View</option>
          <option value="swap">Swap</option>
          <option value="double">Double (A/B or B/C → auto MDO)</option>
        </select>
      </div>

      <button id="prevBtn">◀ Prev</button>
      <button id="nextBtn">Next ▶</button>
      <button id="thisBtn">This Month</button>

      <div class="spacer"></div>

      <div class="ctl">
        <div>ME</div>
        <select id="meSel"></select>
      </div>
      <div class="ctl">
        <div>SWAP WITH</div>
        <select id="themSel"></select>
      </div>

      <button id="resetSwapsBtn">Reset Swaps</button>
      <button class="primary" id="genFormBtn">Generate Form (Print)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill" id="statusMode">MODE: VIEW</span>
      <span class="pill" id="statusPick">PICK: —</span>
      <span class="pill" id="statusValidation">VALIDATION: —</span>

      <div class="spacer"></div>

      <button class="danger" id="lockBaselineBtn">Lock Baseline (prevents non-week swaps)</button>
      <button id="unlockBaselineBtn">Unlock Baseline</button>
    </div>

    <div class="legend">
      <span class="chip"><span class="sw b"></span> B day</span>
      <span class="chip"><span class="sw a"></span> A night</span>
      <span class="chip"><span class="sw c"></span> C evening</span>
      <span class="chip"><span class="sw rdo"></span> RDO</span>
      <span class="chip"><span class="sw mdo"></span> MDO</span>
      <span class="chip"><span class="sw hol"></span> HOL</span>
      <span class="chip"><span class="sw pick"></span> picked</span>
      <span class="chip"><span class="sw swap"></span> swap target</span>
    </div>
  </div>

  <div class="wrap" id="monthsWrap"></div>

  <div class="wrap">
    <div class="help">
      <b>How to use swap:</b>
      1) Set <b>Mode = Swap</b>
      2) Pick <b>ME</b> + <b>SWAP WITH</b>
      3) Click a day cell on <b>ME row</b>, then click a day cell on <b>THEM row</b><br/><br/>
      <b>Note:</b> If you still see code printed on screen, you are not serving this as <b>index.html</b>.
    </div>
  </div>

<script>
  const SLOT_TEMPLATES = {
    1: ["RDO","B","B","B","B","B","RDO","RDO","B","B","B","B","B","RDO","RDO","C","C","C","C","C","RDO","RDO","A","A","A","A","A","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO"],
    2: ["B","B","B","B","B","RDO","RDO","C","C","C","C","C","RDO","RDO","A","A","A","A","A","RDO","RDO","B","B","B","B","B","RDO","RDO","R","R","R","R","R","RDO","RDO","B","B","B","B","B","RDO","RDO"],
    3: ["RDO","B","B","B","B","RDO","RDO","RDO","R","R","R","R","RDO","RDO","RDO","C","C","C","C","RDO","RDO","RDO","A","A","A","A","RDO","RDO","RDO","B","B","B","B","RDO","RDO","RDO","C","C","C","C","RDO","RDO"],
    4: ["RDO","R","R","R","R","RDO","RDO","RDO","C","C","C","C","RDO","RDO","RDO","B","B","B","B","RDO","RDO","RDO","A","A","A","A","RDO","RDO","RDO","R","R","R","R","RDO","RDO","RDO","B","B","B","B","RDO","RDO"],
    5: ["RDO","C","C","C","C","C","RDO","RDO","B","B","B","B","B","RDO","RDO","A","A","A","A","A","RDO","RDO","R","R","R","R","RDO","RDO","RDO","C","C","C","C","C","RDO","RDO","B","B","B","B","B","RDO"],
    6: ["C","C","C","C","C","RDO","RDO","B","B","B","B","B","RDO","RDO","A","A","A","A","A","RDO","RDO","R","R","R","R","R","RDO","RDO","C","C","C","C","C","RDO","RDO","B","B","B","B","B","RDO","RDO"],
  };

  const TEMPLATE_ANCHOR_ISO = "2026-02-01"; // must be a Sunday

  const HOLIDAYS = new Set(["2026-01-01","2026-01-19","2026-02-16"]);

  const EMPLOYEES = [
    { name:"Kingston, Joseph C.", slot:1 },
    { name:"Rodriguez, Roger", slot:1 },
    { name:"Joseph, George R", slot:2 },
    { name:"Ramnarine, Ashram", slot:2 },
    { name:"Segovia, Eduardo M", slot:3 },
    { name:"Victoria, Robert", slot:3 },
    { name:"Bouaziz, Abdelghani", slot:4 },
    { name:"Gragossian, Alani", slot:4 },
    { name:"Handel, Joseph", slot:5 },
    { name:"Rakhmanov, Ravshan", slot:5 },
    { name:"Rodriguez, Alexander", slot:6 },
    { name:"Svenjak, Mark", slot:6 },
  ];

  const LS_KEY = "rotShiftSwapTool_v2";
  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch(e){ return null; } }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function isoMonth(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
  function parseISODate(iso){ const [y,m,dd]=iso.split("-").map(Number); return new Date(y,m-1,dd); }
  function parseISOMonth(iso){ const [y,m]=iso.split("-").map(Number); return new Date(y,m-1,1); }
  function addMonths(date,n){ return new Date(date.getFullYear(), date.getMonth()+n, 1); }
  function daysInMonth(y,m0){ return new Date(y,m0+1,0).getDate(); }
  function dowShort(d){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]; }
  function isWeekend(d){ return d.getDay()===0 || d.getDay()===6; }
  function weekStartSundayISO(iso){
    const d=parseISODate(iso);
    const ws=new Date(d.getFullYear(), d.getMonth(), d.getDate()-d.getDay());
    return isoDate(ws);
  }
  function sameWeek(a,b){ return weekStartSundayISO(a)===weekStartSundayISO(b); }
  function getEmp(name){ return EMPLOYEES.find(e=>e.name===name)||null; }

  function getTemplateIndex(iso){
    const a=parseISODate(TEMPLATE_ANCHOR_ISO);
    const d=parseISODate(iso);
    const ms=24*60*60*1000;
    const diff=Math.floor((d-a)/ms);
    return ((diff%42)+42)%42;
  }

  const state = loadState() || {
    startMonthISO: isoMonth(new Date()),
    showMonths: 3,
    mode: "view",
    me: EMPLOYEES[0]?.name || "",
    them: EMPLOYEES[1]?.name || "",
    baselineLocked: false,
    overrides: {},
    changeLog: [],
    doubleMDOChoice: {},
  };

  let pick=null;

  function baseCode(person, iso){
    const emp=getEmp(person);
    if(!emp) return "";
    const arr=SLOT_TEMPLATES[emp.slot];
    if(!arr) return "";
    return arr[getTemplateIndex(iso)] || "";
  }
  function getOverride(person, iso){ return state.overrides?.[person]?.[iso] ?? null; }
  function setOverride(person, iso, code){
    if(!state.overrides[person]) state.overrides[person]={};
    state.overrides[person][iso]=code;
  }

  function displayCode(person, iso){
    const ov=getOverride(person, iso);
    const code=ov ?? baseCode(person, iso);
    if(["COMP","PE","SICK","IOD","DIF"].includes(code)) return code;
    if(HOLIDAYS.has(iso)) return "HOL";
    return code;
  }

  function isOff(code){ return ["RDO","MDO","COMP","PE","SICK","IOD","DIF","HOL"].includes(code); }

  function validateSwap(me, them, isoMe, isoThem){
    const errors=[];
    if(!me||!them) errors.push("Pick ME and SWAP WITH.");
    if(me===them) errors.push("ME and SWAP WITH must be different.");
    if(!sameWeek(isoMe, isoThem)) errors.push("Cannot cross weeks (Sun–Sat).");
    if(errors.length) return {ok:false, errors};

    const dMe=parseISODate(isoMe);
    const dThem=parseISODate(isoThem);

    const meCode=displayCode(me, isoMe);
    const themCode=displayCode(them, isoThem);

    // Block OFF<->OFF swap on weekend/holiday (would leave coverage nonsense)
    if((isWeekend(dMe)||HOLIDAYS.has(isoMe)) && isOff(meCode) && isOff(themCode)) errors.push("Invalid: off ↔ off on weekend/holiday.");
    if((isWeekend(dThem)||HOLIDAYS.has(isoThem)) && isOff(meCode) && isOff(themCode)) errors.push("Invalid: off ↔ off on weekend/holiday.");

    return {ok: errors.length===0, errors};
  }

  function doSwap(me, them, isoMe, isoThem){
    const v=validateSwap(me, them, isoMe, isoThem);
    if(!v.ok) return v;
    const a=displayCode(me, isoMe);
    const b=displayCode(them, isoThem);
    setOverride(me, isoMe, b);
    setOverride(them, isoThem, a);
    saveState();
    return {ok:true, errors:[]};
  }

  const monthsWrap=document.getElementById("monthsWrap");
  const showMonthsSel=document.getElementById("showMonths");
  const modeSel=document.getElementById("mode");
  const meSel=document.getElementById("meSel");
  const themSel=document.getElementById("themSel");
  const statusMode=document.getElementById("statusMode");
  const statusPick=document.getElementById("statusPick");
  const statusValidation=document.getElementById("statusValidation");

  function setPill(el, text, kind){
    el.textContent=text;
    el.classList.remove("ok","bad");
    if(kind==="ok") el.classList.add("ok");
    if(kind==="bad") el.classList.add("bad");
  }

  function buildSelectOptions(sel, value){
    sel.innerHTML="";
    for(const e of EMPLOYEES){
      const o=document.createElement("option");
      o.value=e.name;
      o.textContent=e.name;
      sel.appendChild(o);
    }
    sel.value=value;
  }

  function monthTitle(d){
    const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
    return `${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function render(){
    showMonthsSel.value=String(state.showMonths);
    modeSel.value=state.mode;
    buildSelectOptions(meSel, state.me);
    buildSelectOptions(themSel, state.them);

    setPill(statusMode, `MODE: ${state.mode.toUpperCase()}`);
    setPill(statusPick, pick?`PICK: ${pick.person} @ ${pick.iso}`:"PICK: —");

    monthsWrap.innerHTML="";
    const start=parseISOMonth(state.startMonthISO);
    for(let i=0;i<Number(state.showMonths);i++){
      monthsWrap.appendChild(renderMonthPanel(addMonths(start,i)));
    }
  }

  function renderMonthPanel(monthDate){
    const y=monthDate.getFullYear();
    const m0=monthDate.getMonth();
    const dim=daysInMonth(y,m0);

    const panel=document.createElement("div");
    panel.className="panel";

    const hdr=document.createElement("div");
    hdr.className="monthHeader";
    hdr.innerHTML=`<div>${monthTitle(monthDate)}</div><small>Rotating Shift</small>`;
    panel.appendChild(hdr);

    const scroll=document.createElement("div");
    scroll.className="scrollX";
    panel.appendChild(scroll);

    const table=document.createElement("table");
    scroll.appendChild(table);

    const thead=document.createElement("thead");
    table.appendChild(thead);

    const r1=document.createElement("tr");
    thead.appendChild(r1);

    const thName=document.createElement("th");
    thName.className="stickyLeft colName band";
    thName.textContent="NAME";
    r1.appendChild(thName);

    const thSlot=document.createElement("th");
    thSlot.className="stickyLeft2 colSlot band";
    thSlot.textContent="SLOT";
    r1.appendChild(thSlot);

    for(let d=1; d<=dim; d++){
      const th=document.createElement("th");
      th.className="colDay dayTop";
      th.textContent=String(d);
      r1.appendChild(th);
    }

    const r2=document.createElement("tr");
    thead.appendChild(r2);

    const thN2=document.createElement("th");
    thN2.className="stickyLeft colName";
    r2.appendChild(thN2);

    const thS2=document.createElement("th");
    thS2.className="stickyLeft2 colSlot";
    r2.appendChild(thS2);

    for(let d=1; d<=dim; d++){
      const date=new Date(y,m0,d);
      const th=document.createElement("th");
      th.className="colDay dow";
      th.textContent=dowShort(date);
      r2.appendChild(th);
    }

    const tbody=document.createElement("tbody");
    table.appendChild(tbody);

    // Render ME + THEM as a 2-row block at top (same columns)
    if(state.me && state.them && state.me!==state.them){
      tbody.appendChild(renderPersonRow(monthDate, state.me, dim));
      tbody.appendChild(renderPersonRow(monthDate, state.them, dim));
      const div=document.createElement("tr");
      div.className="groupDivider";
      const td=document.createElement("td");
      td.colSpan=2+dim;
      div.appendChild(td);
      tbody.appendChild(div);
    }

    // Then render everyone
    for(const emp of EMPLOYEES){
      tbody.appendChild(renderPersonRow(monthDate, emp.name, dim));
    }

    return panel;
  }

  function renderPersonRow(monthDate, person, dim){
    const y=monthDate.getFullYear();
    const m0=monthDate.getMonth();
    const emp=getEmp(person);

    const tr=document.createElement("tr");
    tr.className="personRow";

    const tdName=document.createElement("td");
    tdName.className="stickyLeft colName nameCell";
    tdName.textContent=person;
    tr.appendChild(tdName);

    const tdSlot=document.createElement("td");
    tdSlot.className="stickyLeft2 colSlot slotCell";
    tdSlot.textContent=emp?`Slot ${emp.slot}`:"";
    tr.appendChild(tdSlot);

    for(let d=1; d<=dim; d++){
      const date=new Date(y,m0,d);
      const iso=isoDate(date);
      const code=displayCode(person, iso);

      const td=document.createElement("td");
      td.className="colDay code";
      if(isWeekend(date)) td.classList.add("wknd");
      td.dataset.person=person;
      td.dataset.iso=iso;
      td.dataset.code=code;
      td.textContent=code;

      if(getOverride(person, iso)!==null) td.classList.add("changed");
      if(pick && pick.person===person && pick.iso===iso) td.classList.add("pick");

      td.addEventListener("click", ()=>onCellClick(td));
      tr.appendChild(td);
    }

    return tr;
  }

  function onCellClick(td){
    if(state.mode==="view") return;

    const person=td.dataset.person;
    const iso=td.dataset.iso;

    if(person!==state.me && person!==state.them){
      setPill(statusValidation, "VALIDATION: click only ME/THEM rows", "bad");
      return;
    }

    if(!pick){
      pick={person, iso};
      render();
      return;
    }

    // second click must be opposite person
    if(pick.person===person){
      pick={person, iso};
      render();
      return;
    }

    const isoMe = (pick.person===state.me) ? pick.iso : iso;
    const isoThem = (pick.person===state.them) ? pick.iso : iso;

    const res=doSwap(state.me, state.them, isoMe, isoThem);
    if(res.ok){
      setPill(statusValidation, "VALIDATION: OK (swapped)", "ok");
      pick=null;
      render();
    }else{
      setPill(statusValidation, `VALIDATION: ${res.errors[0]}`, "bad");
    }
  }

  // Month dropdowns (works on Safari)
  const startMonthSel=document.getElementById("startMonthSel");
  const startYearSel=document.getElementById("startYearSel");
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  for(let i=0;i<12;i++){
    const o=document.createElement("option");
    o.value=String(i+1).padStart(2,"0");
    o.textContent=months[i];
    startMonthSel.appendChild(o);
  }
  const now=new Date();
  const baseYear=now.getFullYear();
  for(let y=baseYear-1; y<=baseYear+3; y++){
    const o=document.createElement("option");
    o.value=String(y);
    o.textContent=String(y);
    startYearSel.appendChild(o);
  }

  function syncMonthDropdownFromState(){
    const [yy,mm]=state.startMonthISO.split("-");
    startYearSel.value=yy;
    startMonthSel.value=mm;
  }
  function setStateMonthFromDropdown(){
    const yy=startYearSel.value;
    const mm=startMonthSel.value;
    state.startMonthISO = `${yy}-${mm}`;
    saveState();
    render();
  }

  document.getElementById("prevBtn").addEventListener("click", ()=>{
    const d=parseISOMonth(state.startMonthISO);
    state.startMonthISO=isoMonth(addMonths(d,-1));
    saveState();
    syncMonthDropdownFromState();
    render();
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    const d=parseISOMonth(state.startMonthISO);
    state.startMonthISO=isoMonth(addMonths(d,1));
    saveState();
    syncMonthDropdownFromState();
    render();
  });
  document.getElementById("thisBtn").addEventListener("click", ()=>{
    state.startMonthISO=isoMonth(new Date());
    saveState();
    syncMonthDropdownFromState();
    render();
  });

  startMonthSel.addEventListener("change", setStateMonthFromDropdown);
  startYearSel.addEventListener("change", setStateMonthFromDropdown);

  showMonthsSel.addEventListener("change", ()=>{
    state.showMonths=Number(showMonthsSel.value);
    saveState(); render();
  });
  modeSel.addEventListener("change", ()=>{
    state.mode=modeSel.value;
    pick=null;
    saveState(); render();
  });
  meSel.addEventListener("change", ()=>{
    state.me=meSel.value;
    if(state.them===state.me) state.them=EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;
    pick=null;
    saveState(); render();
  });
  themSel.addEventListener("change", ()=>{
    state.them=themSel.value;
    if(state.them===state.me) state.them=EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;
    pick=null;
    saveState(); render();
  });

  document.getElementById("resetSwapsBtn").addEventListener("click", ()=>{
    state.overrides={};
    state.changeLog=[];
    pick=null;
    saveState();
    setPill(statusValidation, "VALIDATION: reset", null);
    render();
  });

  document.getElementById("lockBaselineBtn").addEventListener("click", ()=>{
    state.baselineLocked=true;
    saveState();
    setPill(statusValidation, "VALIDATION: baseline locked", "ok");
  });
  document.getElementById("unlockBaselineBtn").addEventListener("click", ()=>{
    state.baselineLocked=false;
    saveState();
    setPill(statusValidation, "VALIDATION: baseline unlocked", "ok");
  });

  document.getElementById("genFormBtn").addEventListener("click", ()=>{
    const w=window.open("", "_blank");
    if(!w) return;
    w.document.write("<html><body><h2>Print this window to PDF</h2><p>Form generator placeholder (next step).</p></body></html>");
    w.document.close();
    w.focus();
    w.print();
  });

  // init sanity
  if(!getEmp(state.me)) state.me=EMPLOYEES[0]?.name||"";
  if(!getEmp(state.them) || state.them===state.me) state.them=EMPLOYEES.find(e=>e.name!==state.me)?.name || state.me;

  syncMonthDropdownFromState();
  saveState();
  render();
</script>
</body>
</html>
