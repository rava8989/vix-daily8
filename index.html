<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIX Strategy Helper – 2026</title>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>

  <style>
    /* ──────────────────────────────────────────────── */
    /* Your original CSS – unchanged except one addition */
    /* ──────────────────────────────────────────────── */
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
    }
    /* ... rest of your CSS remains exactly the same ... */

    /* New warning style */
    .schedule-warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      margin: 12px;
      border-radius: 6px;
      border: 1px solid #ffeeba;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <div class="schedule-warning">
      Calendar data valid for 2026 only.<br>
      After Dec 31, 2026 signals may be incorrect!
    </div>

    <details id="scheduleDetails">
      <summary><strong>Schedules 2026</strong></summary>

      <h2>CPI Schedule</h2>
      <ul id="cpiSchedule"></ul>

      <h2>Fed Day Schedule</h2>
      <ul id="fedSchedule"></ul>

      <h2>OPEX Days</h2>
      <ul id="opexSchedule"></ul>

      <h2>Market Holidays</h2>
      <ul id="holidaySchedule"></ul>

      <h2>VIX Expiration</h2>
      <ul id="vixExpirySchedule"></ul>
    </details>
  </div>

  <div class="main">

    <div class="calcRow">
      <div class="winrateBox">
        <h3>Win rate override (previous day)</h3>
        <label>
          <input type="checkbox" id="winrate90" />
          M8BF win rate > 90%
        </label>
        <label>
          <input type="checkbox" id="winrate0" />
          M8BF win rate = 0%
        </label>
      </div>

      <div class="calculator">
        <h1>VIX Calculator</h1>

        <label>VIX Today’s Open:
          <input type="number" id="todayOpen" step="0.01" min="0" max="100" placeholder="e.g. 18.45" />
        </label>

        <label>VIX Yesterday’s Open:
          <input type="number" id="yesterdayOpen" step="0.01" min="0" max="100" placeholder="e.g. 19.20" />
        </label>

        <label>VIX Yesterday’s Close:
          <input type="number" id="yesterdayClose" step="0.01" min="0" max="100" placeholder="e.g. 20.10" />
        </label>

        <button onclick="calculateStrategy()">Calculate</button>
      </div>
    </div>

    <!-- rest of your HTML structure remains the same -->

    <div style="margin-top: 10px; font-size: 14px; text-align: center;">
      <p>
        <strong>Overnight VIX Drop:</strong>
        <span id="overnightDropDisplay">—</span>
        <span id="cpiTag" class="tag" style="display:none;">CPI day</span>
        <span id="fedTag" class="tag" style="display:none;">Fed day</span>
        <span id="opexTag" class="tag" style="display:none;">OPEX</span>
        <span id="postOpexTag" class="tag" style="display:none;">Post-OPEX</span>
        <span id="postHolidayTag" class="tag" style="display:none;">Post-Holiday</span>
        <span id="eomTag" class="tag" style="display:none;">EOM</span>
      </p>
      <p>
        <strong>Yesterday’s VIX Open − Today’s VIX Open:</strong>
        <span id="openDiffDisplay">—</span>
        <span id="openDiffNote" class="tag" style="display:none;">ignored on CPI day</span>
      </p>
    </div>

    <!-- ... rest of your HTML (recBlock, flowchart, strategy-doc etc.) unchanged ... -->

  </div>

  <script>
    // ────────────────────────────────────────────────
    //  HELPER: convert "January 13, 2026" → Date object
    // ────────────────────────────────────────────────
    function parseUSDateLong(str) {
      try {
        const [monthName, day, year] = str.split(/[\s,]+/);
        const monthNames = {
          "January":0, "February":1, "March":2, "April":3, "May":4, "June":5,
          "July":6, "August":7, "September":8, "October":9, "November":10, "December":11
        };
        const m = monthNames[monthName];
        if (m === undefined) return null;
        const d = parseInt(day, 10);
        const y = parseInt(year, 10);
        if (isNaN(d) || isNaN(y)) return null;
        return new Date(y, m, d);
      } catch {
        return null;
      }
    }

    // ────────────────────────────────────────────────
    //  SCHEDULES – now stored with YYYY-MM-DD keys
    // ────────────────────────────────────────────────
    function dateToYYYYMMDD(d) {
      if (!d || isNaN(d)) return null;
      return d.toISOString().slice(0,10);
    }

    const schedules = {
      cpi: [
        "2026-01-13","2026-02-13","2026-03-11","2026-04-10","2026-05-12","2026-06-10",
        "2026-07-14","2026-08-12","2026-09-11","2026-10-14","2026-11-10","2026-12-10"
      ].map(d => new Date(d)),

      fed: [
        "2026-01-28","2026-03-18","2026-04-29","2026-06-17","2026-07-29",
        "2026-09-16","2026-10-28","2026-12-09"
      ].map(d => new Date(d)),

      opex: [
        "2026-01-16","2026-02-20","2026-03-20","2026-04-17","2026-05-15","2026-06-18",
        "2026-07-17","2026-08-21","2026-09-18","2026-10-16","2026-11-20","2026-12-18"
      ].map(d => new Date(d)),

      holidays: [
        "2026-01-01","2026-01-19","2026-02-16","2026-04-03","2026-05-25",
        "2026-06-19","2026-07-03","2026-09-07","2026-11-26","2026-12-25"
      ].map(d => new Date(d)),

      vixExpiry: [
        "2026-01-21","2026-02-18","2026-03-18","2026-04-15","2026-05-20","2026-06-17",
        "2026-07-15","2026-08-19","2026-09-16","2026-10-21","2026-11-18","2026-12-16"
      ].map(d => new Date(d))
    };

    // ────────────────────────────────────────────────
    //  RENDER SCHEDULES (now using YYYY-MM-DD display)
    // ────────────────────────────────────────────────
    function renderSchedule(dates, ulId) {
      const ul = document.getElementById(ulId);
      ul.innerHTML = '';
      dates.forEach(d => {
        if (!d || isNaN(d)) return;
        const li = document.createElement('li');
        li.textContent = d.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
        li.setAttribute('data-date', dateToYYYYMMDD(d));
        ul.appendChild(li);
      });
    }

    renderSchedule(schedules.cpi, 'cpiSchedule');
    renderSchedule(schedules.fed, 'fedSchedule');
    renderSchedule(schedules.opex, 'opexSchedule');
    renderSchedule(schedules.holidays, 'holidaySchedule');
    renderSchedule(schedules.vixExpiry, 'vixExpirySchedule');

    // ────────────────────────────────────────────────
    //  DATE & TRADING DAY HELPERS (improved)
    // ────────────────────────────────────────────────
    const today = new Date();

    function isWeekend(d)    { return d.getDay() === 0 || d.getDay() === 6; }
    function isHoliday(d)    { return schedules.holidays.some(h => dateToYYYYMMDD(h) === dateToYYYYMMDD(d)); }
    function isTradingDay(d) { return !isWeekend(d) && !isHoliday(d); }

    function nextTradingDay(d) {
      let nd = new Date(d);
      do { nd.setDate(nd.getDate() + 1); } while (!isTradingDay(nd));
      return nd;
    }

    function prevTradingDay(d) {
      let pd = new Date(d);
      do { pd.setDate(pd.getDate() - 1); } while (!isTradingDay(pd));
      return pd;
    }

    function isCpiDay()       { return schedules.cpi.some(d => dateToYYYYMMDD(d) === dateToYYYYMMDD(today)); }
    function isFedDay()       { return schedules.fed.some(d => dateToYYYYMMDD(d) === dateToYYYYMMDD(today)); }
    function isOpexDay()      { return schedules.opex.some(d => dateToYYYYMMDD(d) === dateToYYYYMMDD(today)); }
    function isVixExpiryDay() { return schedules.vixExpiry.some(d => dateToYYYYMMDD(d) === dateToYYYYMMDD(today)); }

    function isPostHoliday() {
      return schedules.holidays.some(h => dateToYYYYMMDD(nextTradingDay(h)) === dateToYYYYMMDD(today));
    }

    function isPostOpexDay() {
      return schedules.opex.some(o => dateToYYYYMMDD(nextTradingDay(o)) === dateToYYYYMMDD(today));
    }

    function isPostOpexMonday() {
      return isPostOpexDay() && today.getDay() === 1;
    }

    function isFirstTradingDayOfMonth(d = today) {
      const prev = prevTradingDay(d);
      return prev.getMonth() !== d.getMonth();
    }

    function isLastTradingDayOfMonth(d = today) {
      const next = nextTradingDay(d);
      return next.getMonth() !== d.getMonth();
    }

    function isEomMinusN(n, d = today) {
      let target = new Date(d);
      for (let i = 0; i < n; i++) {
        target = prevTradingDay(target);
      }
      return dateToYYYYMMDD(target) === dateToYYYYMMDD(d);
    }

    function isFirstTradingMondayOfMonth(d = today) {
      let check = new Date(d.getFullYear(), d.getMonth(), 1);
      while (!isTradingDay(check)) check.setDate(check.getDate() + 1);
      while (check.getDay() !== 1) check = nextTradingDay(check);
      return dateToYYYYMMDD(check) === dateToYYYYMMDD(d);
    }

    // ────────────────────────────────────────────────
    //  WIN RATE CHECKBOXES – mutual exclusion + reset on load
    // ────────────────────────────────────────────────
    const winrate90 = document.getElementById('winrate90');
    const winrate0  = document.getElementById('winrate0');

    function enforceMutualExclusion(changed) {
      if (changed === '90' && winrate90.checked) winrate0.checked = false;
      if (changed === '0'  && winrate0.checked)  winrate90.checked = false;
    }

    winrate90.addEventListener('change', () => enforceMutualExclusion('90'));
    winrate0.addEventListener('change',  () => enforceMutualExclusion('0'));

    // Reset on page load (safety)
    winrate90.checked = false;
    winrate0.checked  = false;

    // ────────────────────────────────────────────────
    //  MAIN CALCULATOR LOGIC (updated date checks)
    // ────────────────────────────────────────────────
    function calculateStrategy() {
      const todayOpenVal   = parseFloat(document.getElementById('todayOpen').value);
      const yOpenVal       = parseFloat(document.getElementById('yesterdayOpen').value);
      const yCloseVal      = parseFloat(document.getElementById('yesterdayClose').value);

      if (isNaN(todayOpenVal) || todayOpenVal < 0 || isNaN(yCloseVal) || yCloseVal < 0) {
        alert("Please enter valid positive VIX values for Today’s Open and Yesterday’s Close.");
        return;
      }

      const isCpi = isCpiDay();
      if (!isCpi && (isNaN(yOpenVal) || yOpenVal < 0)) {
        alert("On non-CPI days, please also enter Yesterday’s Open.");
        return;
      }

      const winHigh  = winrate90.checked;
      const winZero  = winrate0.checked;

      const now       = new Date();
      const isMonday  = now.getDay() === 1;
      const isFriday  = now.getDay() === 5;
      const isWednesday = now.getDay() === 3;

      const nmToday     = isFirstTradingDayOfMonth();
      const nmMonday    = isFirstTradingMondayOfMonth();
      const eomToday    = isLastTradingDayOfMonth();
      const eomM1       = isEomMinusN(1);
      const eomM2       = isEomMinusN(2);
      const postOpex    = isPostOpexDay();
      const postHoliday = isPostHoliday();
      const postOpexMon = isPostOpexMonday();
      const vixExpire   = isVixExpiryDay();
      const opexToday   = isOpexDay();
      const opexM1      = schedules.opex.some(o => dateToYYYYMMDD(prevTradingDay(o)) === dateToYYYYMMDD(today));

      // UI tags
      document.getElementById('cpiTag').style.display       = isCpi       ? 'inline-block' : 'none';
      document.getElementById('fedTag').style.display       = isFedDay()  ? 'inline-block' : 'none';
      document.getElementById('opexTag').style.display      = opexToday   ? 'inline-block' : 'none';
      document.getElementById('postOpexTag').style.display  = postOpex    ? 'inline-block' : 'none';
      document.getElementById('postHolidayTag').style.display = postHoliday ? 'inline-block' : 'none';
      document.getElementById('eomTag').style.display       = eomToday    ? 'inline-block' : 'none';

      const overnightDrop = yCloseVal - todayOpenVal;
      const openToOpen    = isCpi ? NaN : (yOpenVal - todayOpenVal);

      document.getElementById('overnightDropDisplay').textContent = overnightDrop.toFixed(2);
      document.getElementById('openDiffDisplay').textContent =
        isCpi ? '—' : (isNaN(openToOpen) ? '—' : openToOpen.toFixed(2));
      document.getElementById('openDiffNote').style.display = isCpi ? 'inline-block' : 'none';

      let rec = "";
      let bg = "#eee";
      let crossed = false;
      let postOpexNote = "";

      if (isCpi) {
        if (overnightDrop > 0) {
          rec = "Long ATM Call @ 9:32 AM (CPI day) — Max entry premium $13";
          bg = "#61f7d6";
        } else {
          rec = "No trade (CPI day — VIX up)";
          bg = "#eee";
          crossed = true;
        }
      } else {
        // Core logic
        if (overnightDrop > 0.65) {
          rec = "GXBF @ 9:36 AM";
          bg = "#fff399";
        } else if (openToOpen > 1.4) {
          rec = "M8 Butterfly";
          bg = "#b49aff";
        } else if (overnightDrop > 0.01 && overnightDrop <= 0.65) {
          rec = "Straddle @ 9:32 AM";
          bg = "#61f7d6";
        } else {
          rec = "M8 Butterfly";
          bg = "#b49aff";
        }

        // Special cases
        if (rec.includes("M8 Butterfly")) {
          if (isFedDay()) {
            rec = "No M8BF (Fed day)";
            bg = "#eee";
            crossed = true;
          } else if (postHoliday) {
            rec = "M8BF post holiday → prefer PM entry";
            bg = "#b49aff";
          }
        }

        // NM Straddle override (except Mondays)
        if (nmToday && !isMonday && (rec.includes("M8 Butterfly") || rec.includes("No M8BF"))) {
          rec = "NM Straddle @ 9:32 AM";
          bg = "#61f7d6";
          crossed = false;
        }

        // EOM Straddle
        if (eomToday) {
          rec = "Straddle @ 9:32 AM (EOM Straddle)";
          bg = "#61f7d6";
          crossed = false;
        }

        // Wednesday revert to M8BF
        if (isWednesday && !isFedDay() && !eomToday && !nmToday && rec.includes("Straddle")) {
          rec = "M8 Butterfly";
          bg = "#b49aff";
        }

        // No Straddle on OPEX
        if (opexToday && rec.includes("Straddle")) {
          rec = "No Straddle (OPEX day)";
          bg = "#eee";
          crossed = true;
        }

        // Post-OPEX Monday note
        if (postOpexMon && rec.includes("M8 Butterfly")) {
          postOpexNote = " (use afternoon times on post-OPEX Mondays)";
        }

        // Win-rate overrides
        if (winZero) {
          if (!rec.includes("No ")) {   // not already blocked
            rec = rec.includes("Straddle") ? rec : "Straddle @ 9:32 AM (prior day 0% M8BF)";
            bg = "#61f7d6";
            crossed = false;
          }
        } else if (winHigh) {
          if (rec === "Straddle @ 9:32 AM") {
            rec = "M8 Butterfly (prior day >90% M8BF)";
            bg = "#b49aff";
            crossed = false;
          }
        }
      }

      // Post-OPEX +1 override (strongest priority)
      if (postOpex && (rec.includes("M8") || rec.includes("Straddle"))) {
        rec = "GXBF @ 9:36 AM (OPEX+1)";
        bg = "#fff399";
        crossed = false;
        postOpexNote = "";
      }

      // Final output
      const mainRec = document.getElementById("mainRec");
      mainRec.innerHTML = crossed ? `<span class="crossed">${rec}${postOpexNote}</span>` : `${rec}${postOpexNote}`;
      document.getElementById("recBlock").style.backgroundColor = bg;

      // BOBF logic
      let bobfBlockReasons = [];
      if (nmMonday)          bobfBlockReasons.push("NM Monday");
      if (vixExpire)         bobfBlockReasons.push("VIX expiry");
      if (opexToday)         bobfBlockReasons.push("OPEX");
      if (opexM1)            bobfBlockReasons.push("OPEX-1");
      if (eomM2)             bobfBlockReasons.push("EOM-2");
      if (eomM1)             bobfBlockReasons.push("EOM-1");
      if (todayOpenVal > 23) bobfBlockReasons.push("VIX > 23");

      const bobfLine = document.getElementById("bobfLine");
      if (bobfBlockReasons.length > 0) {
        bobfLine.innerHTML = `<span class="crossed">No BOBF (${bobfBlockReasons.join(", ")})</span>`;
      } else {
        bobfLine.innerHTML = isFriday ? "BOBF (Friday version)" : "BOBF in play";
      }
    }

    // ────────────────────────────────────────────────
    //  INIT
    // ────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', () => {
      // Mobile collapse
      const mq = window.matchMedia("(max-width: 900px)");
      const details = document.getElementById("scheduleDetails");
      const apply = () => mq.matches ? details.removeAttribute("open") : details.setAttribute("open","");
      apply();
      mq.addEventListener("change", apply);

      // Today labels
      function updateDateLabels() {
        document.getElementById('todayDate').textContent = "Today: " + today.toLocaleDateString();
        document.getElementById('dayLabel').textContent = tradingWeekdayOrdinalLabel(today);
        document.getElementById('resultDayLabel').textContent = tradingWeekdayOrdinalLabel(today);
      }

      updateDateLabels();

      // Optional: re-run at midnight
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0,0,5,0);
      setTimeout(() => {
        location.reload(); // simplest way to refresh everything
      }, tomorrow - Date.now());
    });

    // Your original ordinal & trading weekday label functions can stay
    // (I didn't change them – they seem fine for your use case)
    function ordinal(n) {
      const s = ["th","st","nd","rd"];
      const v = n % 100;
      return n + (s[(v-20)%10] || s[v] || s[0]);
    }

    function weekdayName(dow) {
      return ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dow] || "";
    }

    function tradingWeekdayOrdinalLabel(date = new Date()) {
      const dow = date.getDay();
      const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
      let count = 0;
      for (let d = new Date(monthStart); d <= date; d.setDate(d.getDate() + 1)) {
        if (!isTradingDay(d)) continue;
        if (d.getDay() === dow) count++;
      }
      if (!isTradingDay(date)) return `${weekdayName(dow)} (market closed)`;
      return `${ordinal(count)} ${weekdayName(dow)}`;
    }
  </script>
</body>
</html>
