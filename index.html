<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rotating Shift — Schedule + Swap</title>

  <style>
    :root{
      --ink:#111;
      --grid:#1f1f1f;
      --hdr:#0f0f0f;
      --hdr2:#1b1b1b;
      --paper:#ffffff;

      --fillWhite:#ffffff;
      --fillGray:#d9d9d9;
      --fillDark:#2a2a2a;

      --accentRed:#b10014;
      --pick:#000;
      --chg:#000;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--paper); color:var(--ink); font-family: Arial, Helvetica, sans-serif; }

    header{
      border-bottom:3px solid var(--grid);
      padding:12px 14px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:800;
      color:#222;
      margin:0 0 6px 2px;
    }

    select,input{
      padding:10px 12px;
      border:2px solid var(--grid);
      border-radius:10px;
      background:#fff;
      font-weight:900;
      min-width:220px;
    }

    button{
      padding:10px 12px;
      border:2px solid var(--grid);
      border-radius:10px;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    button.primary{ background:#111; color:#fff; }
    button.danger{ background:#b10014; color:#fff; border-color:#b10014; }
    button:hover{ opacity:.88; }

    main{ padding:12px 14px 28px; }

    .bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .pill{
      border:2px solid var(--grid);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      background:#fff;
    }
    .pill.ok{ border-color:#1b5e20; color:#1b5e20; }
    .pill.bad{ border-color:#b10014; color:#b10014; }

    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1100px){
      .layout{ grid-template-columns: 1fr 1fr; }
    }

    .pane{
      border:2px solid var(--grid);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }

    .paneHead{
      background:var(--hdr);
      color:#fff;
      padding:10px 12px;
      border-bottom:2px solid var(--grid);
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }
    .paneTitle{ font-weight:900; letter-spacing:.4px; }
    .paneSub{ font-size:12px; opacity:.9; font-weight:800; }

    .months{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
      background:#fff;
    }
    @media (min-width: 1350px){
      .months{ grid-template-columns: 1fr 1fr; }
    }

    .monthCard{
      border:2px solid var(--grid);
      border-radius:12px;
      overflow:hidden;
    }
    .monthHead{
      background:var(--hdr2);
      color:#fff;
      padding:8px 10px;
      border-bottom:2px solid var(--grid);
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }
    .monthTitle{ font-weight:900; font-size:13px; }
    .monthTag{ font-weight:800; font-size:12px; opacity:.9; }

    table.cal{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    table.cal th, table.cal td{
      border:2px solid var(--grid);
      text-align:center;
      padding:0;
    }
    table.cal th{
      background:#000;
      color:#fff;
      font-size:11px;
      font-weight:900;
      padding:6px 2px;
      letter-spacing:.2px;
    }
    td.cell{
      height:46px;
      position:relative;
      user-select:none;
      cursor:pointer;
    }
    td.blank{ background:#fff; cursor:default; }

    tr.w0 td.cell{ background:#f1f1f1; }
    tr.w1 td.cell{ background:#e6e6e6; }

    .dayNum{
      position:absolute;
      top:3px; left:5px;
      font-size:10px;
      font-weight:900;
      color:#222;
    }
    .code{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:14px;
      letter-spacing:.3px;
    }

    .A{ background:var(--fillDark); color:#fff; }
    .B{ background:var(--fillWhite); color:#111; }
    .C{ background:var(--fillGray); color:#111; }
    .RDO{ background:var(--fillDark); color:#fff; }
    .MDO{ background:#bfbfbf; color:#111; }
    .R{ background:#ededed; color:#111; }
    .HOL{ background:#ffe8ea; color:var(--accentRed); }
    .COMP,.PE,.SICK,.IOD,.DIF{ background:#e9f2ff; color:#111; }

    .picked{ outline:4px solid var(--pick); outline-offset:-4px; }
    .changed{ box-shadow: inset 0 0 0 4px var(--chg); }

    .hint{
      border-top:2px solid var(--grid);
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      background:#fff;
    }

    .box{
      border:2px solid var(--grid);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      font-size:12px;
      font-weight:900;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .box.red{
      border-color:#b10014;
      color:#b10014;
    }
  </style>
</head>

<body>
<header>
  <div class="controls">
    <div>
      <label>Start Month</label>
      <input id="startMonth" type="month"/>
    </div>

    <div>
      <label>Show Months</label>
      <select id="monthsShown">
        <option value="3">3</option>
        <option value="4" selected>4</option>
      </select>
    </div>

    <div>
      <label>Mode</label>
      <select id="mode">
        <option value="view" selected>View</option>
        <option value="swap">Swap</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="prev">◀ Prev</button>
      <button id="next">Next ▶</button>
      <button id="thisMonth" class="primary">This Month</button>
    </div>
  </div>

  <div class="controls">
    <div>
      <label>ME</label>
      <select id="me"></select>
    </div>
    <div>
      <label>SWAP WITH</label>
      <select id="them"></select>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button id="resetSwaps">Reset Swaps</button>
      <button id="exportForm" class="primary">Generate Form (PDF/JPG)</button>
    </div>
  </div>
</header>

<main>
  <div class="bar">
    <span class="pill" id="pillMode">MODE: VIEW</span>
    <span class="pill" id="pillBase">BASELINE: NOT LOCKED</span>
    <span class="pill" id="pillValid">VALIDATION: —</span>
    <button id="lockBaseline" class="danger">Lock Baseline (Jan–Mar 2026)</button>
    <button id="resetBaseline">Reset Baseline</button>
  </div>

  <div class="layout">
    <section class="pane">
      <div class="paneHead">
        <div class="paneTitle" id="leftTitle">ME</div>
        <div class="paneSub" id="leftSub">Click a day here, then a day on THEM to swap.</div>
      </div>
      <div class="months" id="leftMonths"></div>
      <div class="hint" id="leftHint"></div>
    </section>

    <section class="pane">
      <div class="paneHead">
        <div class="paneTitle" id="rightTitle">THEM</div>
        <div class="paneSub" id="rightSub">Swap mode requires selecting both people.</div>
      </div>
      <div class="months" id="rightMonths"></div>
      <div class="hint" id="rightHint"></div>
    </section>
  </div>

  <div id="errors" class="box red" style="display:none; margin-top:12px;"></div>

  <div class="box" style="margin-top:12px;">
Rules enforced (basic):
• Week = SUN → SAT
• If a week has NO time-off codes (HOL/COMP/PE/SICK/IOD/DIF), it must contain exactly 5 shifts (A/B/C/R) and 2 RDO
• Swap is done by clicking one day on ME + one day on THEM
• HOL/COMP/PE/SICK/IOD/DIF are treated as “time-off modifiers” (they don’t define the baseline loop)
  </div>
</main>

<script>
/* =========================================================
   EDIT THIS LIST to match your rotating shift mid-section
   ========================================================= */
const EMPLOYEES = [
  // SLOT 1
  { name: "Kingston, Joseph C", slot: 1 },
  { name: "Rodriguez, Roger", slot: 1 },

  // SLOT 2
  { name: "Joseph, George R", slot: 2 },
  { name: "Ramanrane, Ashram", slot: 2 },

  // SLOT 3
  { name: "Segovia, Eduardo M", slot: 3 },
  { name: "Victoria, Robert", slot: 3 },

  // SLOT 4
  { name: "Bouaziz, Abdelghani", slot: 4 },
  { name: "Gragossian, Alani", slot: 4 },

  // SLOT 5
  { name: "Handel, Joseph", slot: 5 },
  { name: "Rakhmanov, Ravshan", slot: 5 },

  // SLOT 6
  { name: "Rodriguez, Alexander", slot: 6 },
  { name: "Svenjak, Mark", slot: 6 },
];

const K_BASELINE = "pa_rot_baseline_42";
const K_SWAPS = "pa_rot_swaps";
const K_BASELINE_LOCKED = "pa_rot_baseline_locked";

const TIME_OFF = new Set(["HOL","COMP","PE","SICK","IOD","DIF"]);
const WORK = new Set(["A","B","C","R"]);

const pad2 = (n)=>String(n).padStart(2,"0");
const isoDate = (y,m,d)=>`${y}-${pad2(m)}-${pad2(d)}`;
const daysInMonth = (y,m)=>new Date(y,m,0).getDate();
const addMonths = (y,m,delta)=>{
  const dt = new Date(y, (m-1)+delta, 1);
  return { y: dt.getFullYear(), m: dt.getMonth()+1 };
};
const monthLabel = (y,m)=>new Date(y,m-1,1).toLocaleString(undefined,{month:"long",year:"numeric"});
const startOfDay = (iso)=>{ const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return d; };
const daysBetween = (aISO,bISO)=>Math.floor((startOfDay(bISO)-startOfDay(aISO))/(24*60*60*1000));

function buildMonthCells(y,m){
  const dim = daysInMonth(y,m);
  const firstDow = new Date(y,m-1,1).getDay();
  const cells = [];
  for(let i=0;i<firstDow;i++) cells.push(null);
  for(let d=1; d<=dim; d++) cells.push(d);
  while(cells.length % 7 !== 0) cells.push(null);
  return {dim, cells};
}
function weekKeyForISO(iso){
  const dt = new Date(iso+"T00:00:00");
  const dow = dt.getDay();
  dt.setDate(dt.getDate()-dow);
  dt.setHours(0,0,0,0);
  return dt.toISOString().slice(0,10);
}
const DOW = ["SUN","MON","TUE","WED","THU","FRI","SAT"];

const DEFAULT_BASELINE_42 = [
  "RDO","B","B","B","B","B","RDO",
  "RDO","A","A","A","A","A","RDO",
  "RDO","C","C","C","C","C","RDO",
  "RDO","B","B","B","B","B","RDO",
  "RDO","A","A","A","A","A","RDO",
  "RDO","C","C","C","C","C","RDO",
];

const CYCLE_START = "2026-01-04";
const CYCLE_LEN = 42;

function norm(code){
  return (code ?? "").toString().trim().toUpperCase();
}

function loadBaseline(){
  const locked = localStorage.getItem(K_BASELINE_LOCKED) === "1";
  const raw = localStorage.getItem(K_BASELINE);
  if(raw){
    try{
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length === 42){
        return { locked, arr };
      }
    }catch{}
  }
  return { locked:false, arr:[...DEFAULT_BASELINE_42] };
}
function saveBaseline(arr){
  localStorage.setItem(K_BASELINE, JSON.stringify(arr));
  localStorage.setItem(K_BASELINE_LOCKED, "1");
}
function resetBaseline(){
  localStorage.removeItem(K_BASELINE);
  localStorage.removeItem(K_BASELINE_LOCKED);
}
function codeFromBaseline(dateISO, slot, baseline42){
  const days = daysBetween(CYCLE_START, dateISO);
  const offset = (slot-1)*7;
  const idx = ((days+offset)%CYCLE_LEN + CYCLE_LEN) % CYCLE_LEN;
  return baseline42[idx];
}

function loadSwaps(){
  const raw = localStorage.getItem(K_SWAPS);
  if(!raw) return {};
  try{
    const obj = JSON.parse(raw);
    return obj && typeof obj==="object" ? obj : {};
  }catch{
    return {};
  }
}
function saveSwaps(obj){
  localStorage.setItem(K_SWAPS, JSON.stringify(obj));
}
function resetSwaps(){
  localStorage.removeItem(K_SWAPS);
}

const elStartMonth = document.getElementById("startMonth");
const elMonthsShown = document.getElementById("monthsShown");
const elMode = document.getElementById("mode");
const elMe = document.getElementById("me");
const elThem = document.getElementById("them");

const elLeftMonths = document.getElementById("leftMonths");
const elRightMonths = document.getElementById("rightMonths");

const pillMode = document.getElementById("pillMode");
const pillBase = document.getElementById("pillBase");
const pillValid = document.getElementById("pillValid");
const elErrors = document.getElementById("errors");

const leftTitle = document.getElementById("leftTitle");
const rightTitle = document.getElementById("rightTitle");
const leftHint = document.getElementById("leftHint");
const rightHint = document.getElementById("rightHint");

let pageOffset = 0;
let pick = null;

function initSelectors(){
  elMe.innerHTML = "";
  elThem.innerHTML = "";
  EMPLOYEES.forEach((p, idx)=>{
    const o1 = document.createElement("option");
    o1.value = String(idx);
    o1.textContent = `${p.name} (Slot ${p.slot})`;
    elMe.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value = String(idx);
    o2.textContent = `${p.name} (Slot ${p.slot})`;
    elThem.appendChild(o2);
  });
  elMe.value = "0";
  elThem.value = "1";
}

function getMonthsWindow(){
  const n = Number(elMonthsShown.value);
  const [y,m] = elStartMonth.value.split("-").map(Number);
  const maxOffset = Math.max(0, 12 - n);
  pageOffset = Math.max(0, Math.min(pageOffset, maxOffset));
  const months = [];
  for(let i=0;i<n;i++){
    const mm = addMonths(y,m,pageOffset+i);
    months.push(mm);
  }
  return months;
}

function buildBaseScheduleForPerson(personIndex, months, baseline42){
  const person = EMPLOYEES[personIndex];
  const map = new Map();
  for(const {y,m} of months){
    const dim = daysInMonth(y,m);
    for(let d=1; d<=dim; d++){
      const iso = isoDate(y,m,d);
      map.set(iso, codeFromBaseline(iso, person.slot, baseline42));
    }
  }
  return map;
}

function applyOverrides(personIndex, baseMap, swapsObj){
  const out = new Map(baseMap);
  const key = String(personIndex);
  if(swapsObj[key]){
    for(const [iso, code] of Object.entries(swapsObj[key])){
      if(out.has(iso)) out.set(iso, norm(code));
    }
  }
  return out;
}

function setOverride(swapsObj, personIndex, iso, code){
  const pkey = String(personIndex);
  swapsObj[pkey] = swapsObj[pkey] || {};
  swapsObj[pkey][iso] = norm(code);
}
function clearOverride(swapsObj, personIndex, iso){
  const pkey = String(personIndex);
  if(swapsObj[pkey] && swapsObj[pkey][iso] != null){
    delete swapsObj[pkey][iso];
  }
}

function validatePerson(personIndex, months, requestedMap){
  const errs = [];
  const isos = [];
  for(const {y,m} of months){
    const dim = daysInMonth(y,m);
    for(let d=1; d<=dim; d++) isos.push(isoDate(y,m,d));
  }

  const buckets = new Map();
  for(const iso of isos){
    const wk = weekKeyForISO(iso);
    const arr = buckets.get(wk) || [];
    arr.push(iso);
    buckets.set(wk, arr);
  }

  for(const [wk, arr] of buckets.entries()){
    let shifts = 0, rdo = 0, hasTimeOff=false;
    for(const iso of arr){
      const c = norm(requestedMap.get(iso));
      if(TIME_OFF.has(c)) hasTimeOff=true;
      if(c==="RDO") rdo++;
      if(WORK.has(c)) shifts++;
    }
    if(!hasTimeOff){
      if(rdo !== 2) errs.push(`Week ${wk}: ${EMPLOYEES[personIndex].name} must have 2 RDO (found ${rdo})`);
      if(shifts !== 5) errs.push(`Week ${wk}: ${EMPLOYEES[personIndex].name} must have 5 shifts (found ${shifts})`);
    }
  }
  return errs;
}

function cellClass(code){
  const c = norm(code);
  const ok = ["A","B","C","RDO","MDO","R","HOL","COMP","PE","SICK","IOD","DIF"];
  return ok.includes(c) ? c : "";
}

function renderMonth(personIndex, month, baseMap, reqMap, side){
  const {y,m} = month;
  const {cells} = buildMonthCells(y,m);

  let html = `
    <div class="monthCard">
      <div class="monthHead">
        <div class="monthTitle">${monthLabel(y,m)}</div>
        <div class="monthTag">${y}-${pad2(m)}</div>
      </div>
      <table class="cal">
        <thead><tr>${DOW.map(d=>`<th>${d}</th>`).join("")}</tr></thead>
        <tbody>
  `;

  for(let r=0; r<cells.length/7; r++){
    const stripe = (r%2===0) ? "w0" : "w1";
    html += `<tr class="${stripe}">`;

    for(let c=0;c<7;c++){
      const day = cells[r*7+c];
      if(day==null){
        html += `<td class="blank"></td>`;
        continue;
      }
      const iso = isoDate(y,m,day);
      const code = reqMap.get(iso);
      const base = baseMap.get(iso);

      const pickedCls = (pick && pick.side===side && pick.iso===iso) ? "picked" : "";
      const changedCls = (norm(code) !== norm(base)) ? "changed" : "";

      html += `
        <td class="cell ${pickedCls} ${changedCls}" data-side="${side}" data-person="${personIndex}" data-iso="${iso}">
          <div class="dayNum">${day}</div>
          <div class="code ${cellClass(code)}">${norm(code)}</div>
        </td>
      `;
    }
    html += `</tr>`;
  }

  html += `</tbody></table></div>`;
  return html;
}

function doSwap(isoMe, isoThem){
  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);

  const baseline = loadBaseline().arr;
  const months = getMonthsWindow();
  const swapsObj = loadSwaps();

  const baseMe = buildBaseScheduleForPerson(meIdx, months, baseline);
  const baseTh = buildBaseScheduleForPerson(thIdx, months, baseline);

  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);
  const reqTh = applyOverrides(thIdx, baseTh, swapsObj);

  const a = norm(reqMe.get(isoMe));
  const b = norm(reqTh.get(isoThem));

  setOverride(swapsObj, meIdx, isoMe, b);
  setOverride(swapsObj, thIdx, isoThem, a);

  if(norm(b) === norm(baseMe.get(isoMe))) clearOverride(swapsObj, meIdx, isoMe);
  if(norm(a) === norm(baseTh.get(isoThem))) clearOverride(swapsObj, thIdx, isoThem);

  saveSwaps(swapsObj);
}

function lockBaselineJanToMar(){
  // locks whatever baseline is currently loaded
  const b = loadBaseline().arr;
  saveBaseline(b);
}

function openFormPrint(){
  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);
  const me = EMPLOYEES[meIdx];
  const th = EMPLOYEES[thIdx];

  const baseline = loadBaseline().arr;
  const months = getMonthsWindow();
  const swapsObj = loadSwaps();

  const month = months[0];
  const {y,m} = month;
  const dim = daysInMonth(y,m);

  const baseMe = buildBaseScheduleForPerson(meIdx, months, baseline);
  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);

  function gridLine(map, maxDay){
    let out = "";
    for(let d=1; d<=31; d++){
      const iso = isoDate(y,m,d);
      const code = (d<=maxDay) ? (map.get(iso) || "") : "";
      out += `<div class="cell">${d}<span>${code}</span></div>`;
    }
    return out;
  }

  const today = new Date();
  const dateStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;

  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><title>Swap Form</title>
      <style>
        @page{ size: letter; margin: 0.4in; }
        body{ font-family: Arial; }
        .wrap{ position:relative; width:100%; height:10.3in; }
        .rightTitle{
          position:absolute; right:-1.75in; top:2.2in;
          transform: rotate(90deg);
          font-weight:900; letter-spacing:1px; font-size:20px;
        }
        .rightNote{
          position:absolute; right:-1.65in; top:0.9in;
          transform: rotate(90deg);
          color:#b10014; font-weight:900; font-size:12px;
        }
        .leftNote{
          position:absolute; left:-1.35in; top:0.9in;
          transform: rotate(-90deg);
          color:#b10014; font-weight:900; font-size:12px;
        }
        .topFields{ margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
        .field{ font-size:12px; font-weight:900; }
        .line{ border-bottom:2px solid #222; height:18px; }
        .section{ margin-top:18px; display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
        .gridTitle{ font-weight:900; text-align:center; margin-bottom:6px; }
        .grid{
          display:grid; grid-template-columns: repeat(31, 1fr);
          border:2px solid #222;
        }
        .cell{
          border-right:1px solid #222;
          border-bottom:1px solid #222;
          height:26px; position:relative;
          font-size:10px; font-weight:900;
          display:flex; align-items:flex-start; justify-content:flex-start;
          padding:2px 2px;
        }
        .cell span{
          position:absolute; inset:0;
          display:flex; align-items:center; justify-content:center;
          font-size:11px; font-weight:900;
        }
        .bottom{ position:absolute; bottom:0.35in; left:0; right:0; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:18px; }
        .dateTop{ position:absolute; right:0; top:0; font-weight:900; font-size:12px; }
      </style>
    </head><body>
      <div class="wrap">
        <div class="dateTop">DATE: ${dateStr}</div>
        <div class="rightTitle">TIME OFF OR SHIFT CHANGE REQUEST</div>
        <div class="rightNote">THIS REQUEST IS NOT APPROVED UNTIL YOU RECEIVE A SIGNED COPY OF THIS FORM</div>
        <div class="leftNote">** ALL REQUESTS WILL ONLY BE APPROVED AND SCHEDULED ON TUESDAY & THURSDAY **  8/12/2019</div>

        <div class="topFields">
          <div class="field">TO: SUPERVISOR<div class="line"></div></div>
          <div class="field">FROM:<div class="line"></div></div>
          <div class="field">MONTH:<div class="line">${y}-${String(m).padStart(2,"0")}</div></div>
          <div class="field"></div>
        </div>

        <div class="section">
          <div>
            <div class="field">NAME<div class="line">${me.name}</div></div>
            <div class="gridTitle">MY PRESENT SCHEDULE IS</div>
            <div class="grid">${gridLine(baseMe, dim)}</div>
          </div>

          <div>
            <div class="field">NAME<div class="line">${me.name} (swap with: ${th.name})</div></div>
            <div class="gridTitle">TIME OFF OR CHANGE PERIOD REQUESTED</div>
            <div class="grid">${gridLine(reqMe, dim)}</div>
          </div>
        </div>

        <div class="bottom">
          <div class="field">ENTERED INTO COMPUTER<div class="line"></div></div>
          <div class="field">SUPERVISOR<div class="line"></div></div>
          <div class="field">DATE<div class="line"></div></div>
        </div>
      </div>
      <script>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
}

function render(){
  const months = getMonthsWindow();
  const mode = elMode.value;

  const baselineObj = loadBaseline();
  const baseline = baselineObj.arr;

  pillMode.textContent = `MODE: ${mode.toUpperCase()}`;
  pillBase.textContent = `BASELINE: ${baselineObj.locked ? "LOCKED" : "NOT LOCKED"}`;
  pillBase.className = "pill " + (baselineObj.locked ? "ok" : "bad");

  const meIdx = Number(elMe.value);
  const thIdx = Number(elThem.value);

  leftTitle.textContent = `ME — ${EMPLOYEES[meIdx].name} (Slot ${EMPLOYEES[meIdx].slot})`;
  rightTitle.textContent = `THEM — ${EMPLOYEES[thIdx].name} (Slot ${EMPLOYEES[thIdx].slot})`;

  leftHint.textContent = (mode==="swap")
    ? "Swap mode: click a day on ME then a day on THEM to swap codes."
    : "View mode: shows baseline + saved swaps.";

  rightHint.textContent = (mode==="swap")
    ? "Swap mode: click a day on THEM after you pick one on ME."
    : "View mode: shows baseline + saved swaps.";

  const swapsObj = loadSwaps();

  const baseMe = buildBaseScheduleForPerson(meIdx, months, baseline);
  const baseTh = buildBaseScheduleForPerson(thIdx, months, baseline);

  const reqMe = applyOverrides(meIdx, baseMe, swapsObj);
  const reqTh = applyOverrides(thIdx, baseTh, swapsObj);

  elLeftMonths.innerHTML = months.map(mm => renderMonth(meIdx, mm, baseMe, reqMe, "me")).join("");
  elRightMonths.innerHTML = months.map(mm => renderMonth(thIdx, mm, baseTh, reqTh, "them")).join("");

  const errs = [
    ...validatePerson(meIdx, months, reqMe),
    ...validatePerson(thIdx, months, reqTh),
  ];

  if(errs.length === 0){
    pillValid.textContent = "VALIDATION: OK";
    pillValid.className = "pill ok";
    elErrors.style.display="none";
    elErrors.textContent="";
  }else{
    pillValid.textContent = `VALIDATION: ${errs.length} ISSUE(S)`;
    pillValid.className = "pill bad";
    elErrors.style.display="block";
    elErrors.textContent = errs.map(e=>"• "+e).join("\n");
  }
}

document.getElementById("prev").addEventListener("click", ()=>{ pageOffset = Math.max(0, pageOffset-1); pick=null; render(); });
document.getElementById("next").addEventListener("click", ()=>{ pageOffset = pageOffset+1; pick=null; render(); });
document.getElementById("thisMonth").addEventListener("click", ()=>{
  const now = new Date();
  elStartMonth.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  pageOffset = 0; pick=null; render();
});

document.getElementById("resetSwaps").addEventListener("click", ()=>{ resetSwaps(); pick=null; render(); });
document.getElementById("lockBaseline").addEventListener("click", ()=>{ lockBaselineJanToMar(); pick=null; render(); });
document.getElementById("resetBaseline").addEventListener("click", ()=>{ resetBaseline(); pick=null; render(); });
document.getElementById("exportForm").addEventListener("click", ()=>{ openFormPrint(); });

elStartMonth.addEventListener("change", ()=>{ pageOffset=0; pick=null; render(); });
elMonthsShown.addEventListener("change", ()=>{ pageOffset=0; pick=null; render(); });
elMode.addEventListener("change", ()=>{ pick=null; render(); });
elMe.addEventListener("change", ()=>{ pick=null; render(); });
elThem.addEventListener("change", ()=>{ pick=null; render(); });

document.addEventListener("click", (e)=>{
  const td = e.target.closest("td.cell");
  if(!td) return;

  const mode = elMode.value;
  if(mode !== "swap") return;

  const side = td.getAttribute("data-side");
  const iso = td.getAttribute("data-iso");

  if(!pick){
    pick = { side, iso };
    render();
    return;
  }
  if(pick.side === side){
    pick = { side, iso };
    render();
    return;
  }

  const isoMe = (pick.side==="me") ? pick.iso : iso;
  const isoTh = (pick.side==="them") ? pick.iso : iso;

  doSwap(isoMe, isoTh);
  pick = null;
  render();
});

(function boot(){
  initSelectors();
  const now = new Date();
  elStartMonth.value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  render();
})();
</script>
</body>
</html>
